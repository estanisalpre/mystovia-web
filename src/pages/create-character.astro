---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Create Character - Mystovia">
  <section class="grow z-100 flex-col pt-20 flex items-center justify-center min-h-screen py-12 px-4">
    <!-- Title with decorative elements -->
    <div class="text-center mb-8 z-100">
      <div class="flex items-center justify-center gap-3 mb-2">
        <div class="h-px w-16 bg-gradient-to-r from-transparent to-yellow-500/50"></div>
        <svg class="w-6 h-6 text-yellow-500/60" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
        </svg>
        <div class="h-px w-16 bg-gradient-to-l from-transparent to-yellow-500/50"></div>
      </div>
      <h2 id="createCharTitle" class="text-3xl font-bold text-white medieval-font">Crea tu personaje</h2>
    </div>

    <div class="grid md:grid-cols-2 gap-8 w-full max-w-4xl">
      <!-- Formulario -->
      <div class="relative rounded-xl overflow-hidden">
        <!-- Medieval container background -->
        <div class="absolute inset-0 bg-gradient-to-b from-gray-900/95 via-gray-900/98 to-black/95 border border-yellow-600/20 rounded-xl"></div>

        <!-- Top golden line -->
        <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-yellow-500/50 to-transparent"></div>

        <!-- Diamond pattern overlay -->
        <div class="absolute inset-0 opacity-[0.03] pointer-events-none rounded-xl" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M30 0L60 30L30 60L0 30z\' fill=\'%23d4af37\' fill-opacity=\'0.4\'/%3E%3C/svg%3E'); background-size: 30px 30px;"></div>

        <!-- Corner ornaments -->
        <div class="absolute top-2 left-2 w-6 h-6 opacity-20 pointer-events-none">
          <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
            <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="absolute top-2 right-2 w-6 h-6 opacity-20 pointer-events-none" style="transform: scaleX(-1);">
          <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
            <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="absolute bottom-2 left-2 w-6 h-6 opacity-20 pointer-events-none" style="transform: scaleY(-1);">
          <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
            <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="absolute bottom-2 right-2 w-6 h-6 opacity-20 pointer-events-none" style="transform: scale(-1);">
          <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
            <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
          </svg>
        </div>

        <div class="relative z-10 p-8">
        <form
          id="characterForm"
          class="space-y-6"
        >
          <div>
            <label
              for="characterName"
              id="charNameLabel"
              class="block text-sm font-medium mb-2 text-gray-300"
              >Nombre del personaje</label
            >
            <input
              type="text"
              id="characterName"
              name="characterName"
              required
              minlength="3"
              maxlength="20"
              pattern="[A-Za-z ]+"
              class="w-full px-4 py-3 bg-gray-800/80 border border-yellow-600/20 rounded-lg focus:outline-none focus:border-yellow-500/50 transition-colors text-white placeholder-gray-500"
              placeholder="Ingresa el nombre del personaje"
            />
            <p id="charNameHint" class="text-xs text-gray-500 mt-1">
              Solo letras y espacios. Primer letra en mayúscula.
            </p>
          </div>

          <div>
            <label id="vocationLabel" class="block text-sm font-medium mb-3 text-gray-300">Selecciona la vocación</label
            >
            <div class="space-y-3">
              <label
                class="flex items-center p-4 bg-gray-800/50 border border-yellow-600/20 rounded-lg cursor-pointer hover:border-yellow-500/50 hover:bg-yellow-500/5 transition-all group"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="knight"
                  required
                  class="mr-3 accent-yellow-500"
                />
                <div>
                  <div class="font-semibold text-white group-hover:text-yellow-500 transition-colors">Knight</div>
                </div>
              </label>

              <label
                class="flex items-center p-4 bg-gray-800/50 border border-yellow-600/20 rounded-lg cursor-pointer hover:border-yellow-500/50 hover:bg-yellow-500/5 transition-all group"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="paladin"
                  required
                  class="mr-3 accent-yellow-500"
                />
                <div>
                  <div class="font-semibold text-white group-hover:text-yellow-500 transition-colors">Paladin</div>
                </div>
              </label>

              <label
                class="flex items-center p-4 bg-gray-800/50 border border-yellow-600/20 rounded-lg cursor-pointer hover:border-yellow-500/50 hover:bg-yellow-500/5 transition-all group"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="sorcerer"
                  required
                  class="mr-3 accent-yellow-500"
                />
                <div>
                  <div class="font-semibold text-white group-hover:text-yellow-500 transition-colors">Sorcerer</div>
                </div>
              </label>

              <label
                class="flex items-center p-4 bg-gray-800/50 border border-yellow-600/20 rounded-lg cursor-pointer hover:border-yellow-500/50 hover:bg-yellow-500/5 transition-all group"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="druid"
                  required
                  class="mr-3 accent-yellow-500"
                />
                <div>
                  <div class="font-semibold text-white group-hover:text-yellow-500 transition-colors">Druid</div>
                </div>
              </label>
            </div>
          </div>

          <div
            id="errorMessage"
            class="hidden bg-red-500/10 border border-red-500/30 text-red-400 px-4 py-3 rounded-lg"
          >
          </div>
          <div
            id="successMessage"
            class="hidden bg-green-500/10 border border-green-500/30 text-green-400 px-4 py-3 rounded-lg"
          >
          </div>

          <button
            type="submit"
            id="createCharBtn"
            class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-black font-bold py-3 rounded-lg transition-all border border-yellow-400/30"
          >
            CREAR PERSONAJE
          </button>
        </form>
        </div>
      </div>

      <!-- Personajes existentes -->
      <div class="relative rounded-xl overflow-hidden">
        <!-- Medieval container background -->
        <div class="absolute inset-0 bg-gradient-to-b from-gray-900/95 via-gray-900/98 to-black/95 border border-yellow-600/20 rounded-xl"></div>

        <!-- Top golden line -->
        <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-yellow-500/50 to-transparent"></div>

        <!-- Diamond pattern overlay -->
        <div class="absolute inset-0 opacity-[0.03] pointer-events-none rounded-xl" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M30 0L60 30L30 60L0 30z\' fill=\'%23d4af37\' fill-opacity=\'0.4\'/%3E%3C/svg%3E'); background-size: 30px 30px;"></div>

        <!-- Corner ornaments -->
        <div class="absolute top-2 left-2 w-6 h-6 opacity-20 pointer-events-none">
          <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
            <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="absolute top-2 right-2 w-6 h-6 opacity-20 pointer-events-none" style="transform: scaleX(-1);">
          <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
            <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="absolute bottom-2 left-2 w-6 h-6 opacity-20 pointer-events-none" style="transform: scaleY(-1);">
          <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
            <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="absolute bottom-2 right-2 w-6 h-6 opacity-20 pointer-events-none" style="transform: scale(-1);">
          <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
            <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
          </svg>
        </div>

        <div class="relative z-10 p-8">
          <!-- Header with decorative elements -->
          <div class="flex items-center gap-3 mb-6">
            <div class="h-px flex-1 bg-gradient-to-r from-transparent to-yellow-500/30"></div>
            <h3 id="yourCharsTitle" class="text-xl font-bold text-white medieval-font">Tus personajes</h3>
            <div class="h-px flex-1 bg-gradient-to-l from-transparent to-yellow-500/30"></div>
          </div>

          <div
            id="charactersList"
            class="space-y-3"
          >
            <div id="loadingChars" class="text-gray-400 text-center py-8">
              Cargando personajes...
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { t, getStoredLanguage } from '../i18n/translations';

  const lang = getStoredLanguage();

  // Apply translations
  const createCharTitle = document.getElementById("createCharTitle");
  if (createCharTitle) createCharTitle.textContent = t("character.createCharacter", lang);

  const charNameLabel = document.getElementById("charNameLabel");
  if (charNameLabel) charNameLabel.textContent = t("character.characterName", lang);

  const charNameInput = document.getElementById("characterName") as HTMLInputElement;
  if (charNameInput) charNameInput.placeholder = t("character.characterNamePlaceholder", lang);

  const charNameHint = document.getElementById("charNameHint");
  if (charNameHint) charNameHint.textContent = t("character.characterNameHint", lang);

  const vocationLabel = document.getElementById("vocationLabel");
  if (vocationLabel) vocationLabel.textContent = t("character.selectVocation", lang);

  const createCharBtn = document.getElementById("createCharBtn");
  if (createCharBtn) createCharBtn.textContent = t("character.createButton", lang);

  const yourCharsTitle = document.getElementById("yourCharsTitle");
  if (yourCharsTitle) yourCharsTitle.textContent = t("character.yourCharacters", lang);

  const loadingChars = document.getElementById("loadingChars");
  if (loadingChars) loadingChars.textContent = t("character.loadingCharacters", lang);

  const characterForm = document.getElementById(
    "characterForm"
  ) as HTMLFormElement;
  const errorDiv = document.getElementById("errorMessage")!;
  const successDiv = document.getElementById("successMessage")!;
  const charactersList = document.getElementById("charactersList")!;
  const API_URL = import.meta.env.PUBLIC_API_URL;

  // Check authentication using cookie-based auth
  async function checkAuth() {
    try {
      const response = await fetch(`${API_URL}/api/auth/verify`, {
        credentials: 'include',
      });

      if (!response.ok) {
        // Not authenticated, redirect to login
        window.location.href = "/login";
        return false;
      }

      return true;
    } catch (error) {
      window.location.href = "/login";
      return false;
    }
  }

  async function loadCharacters() {
    try {
      const response = await fetch(`${API_URL}/api/characters`, {
        credentials: 'include', // Use cookies instead of Authorization header
      });

      if (!response.ok) {
        throw new Error("Failed to load characters");
      }

      const data = await response.json();

      if (data.characters.length === 0) {
        charactersList.innerHTML =
          `<div class="text-gray-400 text-center py-8">${t("character.noCharactersYet", lang)}</div>`;
      } else {
        charactersList.innerHTML = data.characters
          .map(
            (char: any) => `
          <div class="relative p-4 rounded-lg border border-yellow-600/20 overflow-hidden" style="background: linear-gradient(to bottom, rgb(31 41 55 / 0.6), rgb(17 24 39 / 0.8));">
            <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-yellow-500/30 to-transparent"></div>
            <div class="flex justify-between items-center">
              <div>
                <div class="font-semibold text-yellow-500">${char.name}</div>
                <div class="text-sm text-gray-400">
                  Level ${char.level} ${char.vocationName}
                </div>
                <div class="text-xs text-gray-500">
                  HP: <span class="text-red-400">${char.health}/${char.healthmax}</span> | MP: <span class="text-blue-400">${char.mana}/${char.manamax}</span>
                </div>
              </div>
              <div class="text-yellow-500/60 text-2xl">⚔️</div>
            </div>
          </div>
        `
          )
          .join("");
      }
    } catch (error) {
      charactersList.innerHTML =
        `<div class="text-red-400 text-center py-8">${t("character.failedToLoadCharacters", lang)}</div>`;
    }
  }

  characterForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    errorDiv.classList.add("hidden");
    successDiv.classList.add("hidden");

    const formData = new FormData(characterForm);
    const name = formData.get("characterName") as string;
    const vocation = formData.get("vocation") as string;

    try {
      const response = await fetch(`${API_URL}/api/characters/create`, {
        method: "POST",
        credentials: 'include', // Use cookies instead of Authorization header
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name, vocation }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Character creation failed");
      }

      successDiv.textContent = t("character.characterCreated", lang);
      successDiv.classList.remove("hidden");

      characterForm.reset();

      setTimeout(() => {
        loadCharacters();
        successDiv.classList.add("hidden");
      }, 2000);
    } catch (error) {
      errorDiv.textContent =
        error instanceof Error ? error.message : "An error occurred";
      errorDiv.classList.remove("hidden");
    }
  });

  // Initialize: Check auth and load characters
  (async () => {
    const isAuthenticated = await checkAuth();
    if (isAuthenticated) {
      loadCharacters();
    }
  })();
</script>
