---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Create Character - Mystovia">
  <section class="grow z-100 flex-col pt-20 flex items-center justify-center min-h-screen py-12 px-4">
    <h2 id="createCharTitle" class="text-3xl font-bold text-center mb-8 z-100">Crea tu personaje</h2>

    <div class="grid md:grid-cols-2 gap-8">
      <!-- Formulario -->
      <div class="bg-black/30 border border-white/30 backdrop-blur-md rounded-lg shadow-xl p-8">
        <form
          id="characterForm"
          class="space-y-6"
        >
          <div>
            <label
              for="characterName"
              id="charNameLabel"
              class="block text-sm font-medium mb-2"
              >Nombre del personaje</label
            >
            <input
              type="text"
              id="characterName"
              name="characterName"
              required
              minlength="3"
              maxlength="20"
              pattern="[A-Za-z ]+"
              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
              placeholder="Ingresa el nombre del personaje"
            />
            <p id="charNameHint" class="text-xs text-gray-400 mt-1">
              Solo letras y espacios. Primer letra en mayúscula.
            </p>
          </div>

          <div>
            <label id="vocationLabel" class="block text-sm font-medium mb-3">Selecciona la vocación</label
            >
            <div class="space-y-3">
              <label
                class="flex items-center p-4 bg-gray-900 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="knight"
                  required
                  class="mr-3"
                />
                <div>
                  <div class="font-semibold">Knight</div>
                  <div class="text-sm text-gray-400">
                  </div>
                </div>
              </label>

              <label
                class="flex items-center p-4 bg-gray-900 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="paladin"
                  required
                  class="mr-3"
                />
                <div>
                  <div class="font-semibold">Paladin</div>
                  <div class="text-sm text-gray-400">
                  </div>
                </div>
              </label>

              <label
                class="flex items-center p-4 bg-gray-900 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="sorcerer"
                  required
                  class="mr-3"
                />
                <div>
                  <div class="font-semibold">Sorcerer</div>
                  <div class="text-sm text-gray-400">
                  </div>
                </div>
              </label>

              <label
                class="flex items-center p-4 bg-gray-900 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="druid"
                  required
                  class="mr-3"
                />
                <div>
                  <div class="font-semibold">Druid</div>
                  <div class="text-sm text-gray-400">
                  </div>
                </div>
              </label>
            </div>
          </div>

          <div
            id="errorMessage"
            class="hidden bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded"
          >
          </div>
          <div
            id="successMessage"
            class="hidden bg-green-900/50 border border-green-700 text-green-200 px-4 py-3 rounded"
          >
          </div>

          <button
            type="submit"
            id="createCharBtn"
            class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 rounded-lg transition transform hover:scale-105"
          >
            CREAR PERSONAJE
          </button>
        </form>
      </div>

      <!-- Personajes existentes -->
      <div class="bg-black/30 border border-white/30 backdrop-blur-md rounded-lg shadow-xl p-8">
        <h3 id="yourCharsTitle" class="text-xl font-bold mb-4">Tus personajes</h3>
        <div
          id="charactersList"
          class="space-y-3"
        >
          <div id="loadingChars" class="text-gray-400 text-center py-8">
            Cargando personajes...
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { t, getStoredLanguage } from '../i18n/translations';

  const lang = getStoredLanguage();

  // Apply translations
  const createCharTitle = document.getElementById("createCharTitle");
  if (createCharTitle) createCharTitle.textContent = t("character.createCharacter", lang);

  const charNameLabel = document.getElementById("charNameLabel");
  if (charNameLabel) charNameLabel.textContent = t("character.characterName", lang);

  const charNameInput = document.getElementById("characterName") as HTMLInputElement;
  if (charNameInput) charNameInput.placeholder = t("character.characterNamePlaceholder", lang);

  const charNameHint = document.getElementById("charNameHint");
  if (charNameHint) charNameHint.textContent = t("character.characterNameHint", lang);

  const vocationLabel = document.getElementById("vocationLabel");
  if (vocationLabel) vocationLabel.textContent = t("character.selectVocation", lang);

  const createCharBtn = document.getElementById("createCharBtn");
  if (createCharBtn) createCharBtn.textContent = t("character.createButton", lang);

  const yourCharsTitle = document.getElementById("yourCharsTitle");
  if (yourCharsTitle) yourCharsTitle.textContent = t("character.yourCharacters", lang);

  const loadingChars = document.getElementById("loadingChars");
  if (loadingChars) loadingChars.textContent = t("character.loadingCharacters", lang);

  const characterForm = document.getElementById(
    "characterForm"
  ) as HTMLFormElement;
  const errorDiv = document.getElementById("errorMessage")!;
  const successDiv = document.getElementById("successMessage")!;
  const charactersList = document.getElementById("charactersList")!;
  const API_URL = import.meta.env.PUBLIC_API_URL;

  // Check authentication using cookie-based auth
  async function checkAuth() {
    try {
      const response = await fetch(`${API_URL}/api/auth/verify`, {
        credentials: 'include',
      });

      if (!response.ok) {
        // Not authenticated, redirect to login
        window.location.href = "/login";
        return false;
      }

      return true;
    } catch (error) {
      window.location.href = "/login";
      return false;
    }
  }

  async function loadCharacters() {
    try {
      const response = await fetch(`${API_URL}/api/characters`, {
        credentials: 'include', // Use cookies instead of Authorization header
      });

      if (!response.ok) {
        throw new Error("Failed to load characters");
      }

      const data = await response.json();

      if (data.characters.length === 0) {
        charactersList.innerHTML =
          `<div class="text-gray-400 text-center py-8">${t("character.noCharactersYet", lang)}</div>`;
      } else {
        charactersList.innerHTML = data.characters
          .map(
            (char: any) => `
          <div class="p-4 bg-gray-900 border border-gray-700 rounded-lg">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-semibold text-yellow-500">${char.name}</div>
                <div class="text-sm text-gray-400">
                  Level ${char.level} ${char.vocationName}
                </div>
                <div class="text-xs text-gray-500">
                  HP: ${char.health}/${char.healthmax} | MP: ${char.mana}/${char.manamax}
                </div>
              </div>
              <div class="text-yellow-500 text-2xl">⚔️</div>
            </div>
          </div>
        `
          )
          .join("");
      }
    } catch (error) {
      charactersList.innerHTML =
        `<div class="text-red-400 text-center py-8">${t("character.failedToLoadCharacters", lang)}</div>`;
    }
  }

  characterForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    errorDiv.classList.add("hidden");
    successDiv.classList.add("hidden");

    const formData = new FormData(characterForm);
    const name = formData.get("characterName") as string;
    const vocation = formData.get("vocation") as string;

    try {
      const response = await fetch(`${API_URL}/api/characters/create`, {
        method: "POST",
        credentials: 'include', // Use cookies instead of Authorization header
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name, vocation }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Character creation failed");
      }

      successDiv.textContent = t("character.characterCreated", lang);
      successDiv.classList.remove("hidden");

      characterForm.reset();

      setTimeout(() => {
        loadCharacters();
        successDiv.classList.add("hidden");
      }, 2000);
    } catch (error) {
      errorDiv.textContent =
        error instanceof Error ? error.message : "An error occurred";
      errorDiv.classList.remove("hidden");
    }
  });

  // Initialize: Check auth and load characters
  (async () => {
    const isAuthenticated = await checkAuth();
    if (isAuthenticated) {
      loadCharacters();
    }
  })();
</script>
