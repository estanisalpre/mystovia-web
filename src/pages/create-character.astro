---
import Layout from "../layouts/Layout.astro";
import DiamondPattern from "../components/ui/DiamondPattern.astro";
import GoldenLine from "../components/ui/GoldenLine.astro";
import CornerOrnaments from "../components/ui/CornerOrnaments.astro";
import { Star } from "@lucide/astro";
---

<Layout
  title="Crear Personaje"
  description="Crea tu personaje en Mystovia. Elige entre Knight, Paladin, Sorcerer o Druid y comienza tu aventura en el mundo de Tibia."
  keywords="crear personaje mystovia, nuevo personaje tibia, knight paladin sorcerer druid, vocaciones tibia"
>
  <section class="grow z-100 flex-col pt-20 flex items-center justify-center min-h-screen py-12 px-4">
    <!-- Title with decorative elements -->
    <div class="text-center mb-8 z-100">
      <div class="flex items-center justify-center gap-3 mb-2">
        <div class="h-px w-16 bg-gradient-to-r from-transparent to-yellow-500/50"></div>
        <Star class="w-6 h-6 text-yellow-500/60" fill="currentColor" />
        <div class="h-px w-16 bg-gradient-to-l from-transparent to-yellow-500/50"></div>
      </div>
      <h2 id="createCharTitle" class="text-3xl font-bold text-white medieval-font">Crea tu personaje</h2>
    </div>

    <div class="grid md:grid-cols-2 gap-8 w-full max-w-4xl">
      <!-- Formulario -->
      <div class="relative rounded-xl overflow-hidden">
        <!-- Medieval container background -->
        <div class="absolute inset-0 bg-gradient-to-b from-gray-900/95 via-gray-900/98 to-black/95 border border-yellow-600/20 rounded-xl"></div>

        <GoldenLine position="top" />
        <DiamondPattern opacity={0.03} class="rounded-xl" />
        <CornerOrnaments variant="curve" size="sm" opacity={0.2} />

        <div class="relative z-10 p-8">
        <form
          id="characterForm"
          class="space-y-6"
        >
          <div>
            <label
              for="characterName"
              id="charNameLabel"
              class="block text-sm font-medium mb-2 text-gray-300"
              >Nombre del personaje</label
            >
            <input
              type="text"
              id="characterName"
              name="characterName"
              required
              minlength="3"
              maxlength="20"
              pattern="[A-Za-z ]+"
              class="w-full px-4 py-3 bg-gray-800/80 border border-yellow-600/20 rounded-lg focus:outline-none focus:border-yellow-500/50 transition-colors text-white placeholder-gray-500"
              placeholder="Ingresa el nombre del personaje"
            />
            <p id="charNameHint" class="text-xs text-gray-500 mt-1">
              Solo letras y espacios. Primer letra en mayúscula.
            </p>
          </div>

          <div>
            <label id="vocationLabel" class="block text-sm font-medium mb-3 text-gray-300">Selecciona la vocación</label
            >
            <div class="space-y-3">
              <label
                class="flex items-center p-4 bg-gray-800/50 border border-yellow-600/20 rounded-lg cursor-pointer hover:border-yellow-500/50 hover:bg-yellow-500/5 transition-all group"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="knight"
                  required
                  class="mr-3 accent-yellow-500"
                />
                <div>
                  <div class="font-semibold text-white group-hover:text-yellow-500 transition-colors">Knight</div>
                </div>
              </label>

              <label
                class="flex items-center p-4 bg-gray-800/50 border border-yellow-600/20 rounded-lg cursor-pointer hover:border-yellow-500/50 hover:bg-yellow-500/5 transition-all group"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="paladin"
                  required
                  class="mr-3 accent-yellow-500"
                />
                <div>
                  <div class="font-semibold text-white group-hover:text-yellow-500 transition-colors">Paladin</div>
                </div>
              </label>

              <label
                class="flex items-center p-4 bg-gray-800/50 border border-yellow-600/20 rounded-lg cursor-pointer hover:border-yellow-500/50 hover:bg-yellow-500/5 transition-all group"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="sorcerer"
                  required
                  class="mr-3 accent-yellow-500"
                />
                <div>
                  <div class="font-semibold text-white group-hover:text-yellow-500 transition-colors">Sorcerer</div>
                </div>
              </label>

              <label
                class="flex items-center p-4 bg-gray-800/50 border border-yellow-600/20 rounded-lg cursor-pointer hover:border-yellow-500/50 hover:bg-yellow-500/5 transition-all group"
              >
                <input
                  type="radio"
                  name="vocation"
                  value="druid"
                  required
                  class="mr-3 accent-yellow-500"
                />
                <div>
                  <div class="font-semibold text-white group-hover:text-yellow-500 transition-colors">Druid</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Checkbox de aceptación de reglas y condiciones -->
          <div class="flex items-start gap-3">
            <input
              type="checkbox"
              id="acceptRules"
              name="acceptRules"
              required
              class="mt-1 w-4 h-4 accent-yellow-500 cursor-pointer"
            />
            <label for="acceptRules" id="acceptRulesLabel" class="text-sm text-gray-300 cursor-pointer">
              Acepto las <a href="/rules" class="text-yellow-500 hover:text-yellow-400 underline" target="_blank">reglas</a> y las <a href="/terms" class="text-yellow-500 hover:text-yellow-400 underline" target="_blank">condiciones</a> del servidor.
            </label>
          </div>

          <div
            id="errorMessage"
            class="hidden bg-red-500/10 border border-red-500/30 text-red-400 px-4 py-3 rounded-lg"
          >
          </div>
          <div
            id="successMessage"
            class="hidden bg-green-500/10 border border-green-500/30 text-green-400 px-4 py-3 rounded-lg"
          >
          </div>

          <button
            type="submit"
            id="createCharBtn"
            disabled
            class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-black font-bold py-3 rounded-lg transition-all border border-yellow-400/30 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:from-yellow-600 disabled:hover:to-yellow-500"
          >
            CREAR PERSONAJE
          </button>
        </form>
        </div>
      </div>

      <!-- Personajes existentes -->
      <div class="relative rounded-xl overflow-hidden">
        <!-- Medieval container background -->
        <div class="absolute inset-0 bg-gradient-to-b from-gray-900/95 via-gray-900/98 to-black/95 border border-yellow-600/20 rounded-xl"></div>

        <GoldenLine position="top" />
        <DiamondPattern opacity={0.03} class="rounded-xl" />
        <CornerOrnaments variant="curve" size="sm" opacity={0.2} />

        <div class="relative z-10 p-8">
          <!-- Header with decorative elements -->
          <div class="flex items-center gap-3 mb-6">
            <div class="h-px flex-1 bg-gradient-to-r from-transparent to-yellow-500/30"></div>
            <h3 id="yourCharsTitle" class="text-xl font-bold text-white medieval-font">Tus personajes</h3>
            <div class="h-px flex-1 bg-gradient-to-l from-transparent to-yellow-500/30"></div>
          </div>

          <div
            id="charactersList"
            class="space-y-3"
          >
            <div id="loadingChars" class="text-gray-400 text-center py-8">
              Cargando personajes...
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { t, getStoredLanguage } from '../i18n/translations';

  function applyTranslations() {
    const lang = getStoredLanguage();

    const createCharTitle = document.getElementById("createCharTitle");
    if (createCharTitle) createCharTitle.textContent = t("character.createCharacter", lang);

    const charNameLabel = document.getElementById("charNameLabel");
    if (charNameLabel) charNameLabel.textContent = t("character.characterName", lang);

    const charNameInput = document.getElementById("characterName") as HTMLInputElement;
    if (charNameInput) charNameInput.placeholder = t("character.characterNamePlaceholder", lang);

    const charNameHint = document.getElementById("charNameHint");
    if (charNameHint) charNameHint.textContent = t("character.characterNameHint", lang);

    const vocationLabel = document.getElementById("vocationLabel");
    if (vocationLabel) vocationLabel.textContent = t("character.selectVocation", lang);

    const createCharBtn = document.getElementById("createCharBtn");
    if (createCharBtn) createCharBtn.textContent = t("character.createButton", lang);

    const yourCharsTitle = document.getElementById("yourCharsTitle");
    if (yourCharsTitle) yourCharsTitle.textContent = t("character.yourCharacters", lang);

    const loadingChars = document.getElementById("loadingChars");
    if (loadingChars) loadingChars.textContent = t("character.loadingCharacters", lang);

    const acceptRulesLabel = document.getElementById("acceptRulesLabel");
    if (acceptRulesLabel) {
      // Preserve the links with underline styling
      acceptRulesLabel.innerHTML = `${t("createCharacter.acceptRulesPrefix", lang)} <a href="/rules" class="text-yellow-500 hover:text-yellow-400 underline" target="_blank">${t("createCharacter.acceptRulesLink", lang)}</a> ${t("createCharacter.acceptRulesAnd", lang)} <a href="/terms" class="text-yellow-500 hover:text-yellow-400 underline" target="_blank">${t("createCharacter.acceptRulesTerms", lang)}</a> ${t("createCharacter.acceptRulesSuffix", lang)}`;
    }
  }

  applyTranslations();
  document.addEventListener('astro:page-load', applyTranslations);

  const lang = getStoredLanguage();

  const characterForm = document.getElementById(
    "characterForm"
  ) as HTMLFormElement;
  const errorDiv = document.getElementById("errorMessage")!;
  const successDiv = document.getElementById("successMessage")!;
  const charactersList = document.getElementById("charactersList")!;
  const acceptRulesCheckbox = document.getElementById("acceptRules") as HTMLInputElement;
  const createCharBtnEl = document.getElementById("createCharBtn") as HTMLButtonElement;
  const API_URL = import.meta.env.PUBLIC_API_URL;

  // Handle checkbox state for button enable/disable
  acceptRulesCheckbox.addEventListener("change", () => {
    createCharBtnEl.disabled = !acceptRulesCheckbox.checked;
  });

  // Check authentication using cookie-based auth
  async function checkAuth() {
    try {
      const response = await fetch(`${API_URL}/api/auth/verify`, {
        credentials: 'include',
      });

      if (!response.ok) {
        // Not authenticated, redirect to login
        window.location.href = "/login";
        return false;
      }

      return true;
    } catch (error) {
      window.location.href = "/login";
      return false;
    }
  }

  async function loadCharacters() {
    try {
      const response = await fetch(`${API_URL}/api/characters`, {
        credentials: 'include', // Use cookies instead of Authorization header
      });

      if (!response.ok) {
        throw new Error("Failed to load characters");
      }

      const data = await response.json();

      if (data.characters.length === 0) {
        charactersList.innerHTML =
          `<div class="text-gray-400 text-center py-8">${t("character.noCharactersYet", lang)}</div>`;
      } else {
        charactersList.innerHTML = data.characters
          .map(
            (char: any) => `
          <div class="relative p-4 rounded-lg border border-yellow-600/20 overflow-hidden" style="background: linear-gradient(to bottom, rgb(31 41 55 / 0.6), rgb(17 24 39 / 0.8));">
            <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-yellow-500/30 to-transparent"></div>
            <div class="flex justify-between items-center">
              <div>
                <div class="font-semibold text-yellow-500">${char.name}</div>
                <div class="text-sm text-gray-400">
                  Level ${char.level} ${char.vocationName}
                </div>
                <div class="text-xs text-gray-500">
                  HP: <span class="text-red-400">${char.health}/${char.healthmax}</span> | MP: <span class="text-blue-400">${char.mana}/${char.manamax}</span>
                </div>
              </div>
              <div class="text-yellow-500/60 text-2xl">⚔️</div>
            </div>
          </div>
        `
          )
          .join("");
      }
    } catch (error) {
      charactersList.innerHTML =
        `<div class="text-red-400 text-center py-8">${t("character.failedToLoadCharacters", lang)}</div>`;
    }
  }

  characterForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    errorDiv.classList.add("hidden");
    successDiv.classList.add("hidden");

    const formData = new FormData(characterForm);
    const name = formData.get("characterName") as string;
    const vocation = formData.get("vocation") as string;

    try {
      const response = await fetch(`${API_URL}/api/characters/create`, {
        method: "POST",
        credentials: 'include', // Use cookies instead of Authorization header
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name, vocation }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Character creation failed");
      }

      successDiv.textContent = t("character.characterCreated", lang);
      successDiv.classList.remove("hidden");

      characterForm.reset();

      setTimeout(() => {
        loadCharacters();
        successDiv.classList.add("hidden");
      }, 2000);
    } catch (error) {
      errorDiv.textContent =
        error instanceof Error ? error.message : "An error occurred";
      errorDiv.classList.remove("hidden");
    }
  });

  // Initialize: Check auth and load characters
  (async () => {
    const isAuthenticated = await checkAuth();
    if (isAuthenticated) {
      loadCharacters();
    }
  })();
</script>
