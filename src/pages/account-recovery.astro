---
import Layout from "../layouts/Layout.astro";
import DiamondPattern from "../components/ui/DiamondPattern.astro";
import GoldenLine from "../components/ui/GoldenLine.astro";
import CornerOrnaments from "../components/ui/CornerOrnaments.astro";
import { Diamond } from "@lucide/astro";
---

<Layout
  title="Recuperación de Cuenta"
  description="Proceso de recuperación de cuenta en Mystovia. Sigue los pasos para recuperar el acceso a tu cuenta."
  keywords="recuperacion cuenta mystovia, recuperar acceso tibia, restaurar cuenta"
>
  <section class="grow z-100 flex items-center justify-center min-h-screen py-16 sm:py-20 px-4 sm:px-6">
    <div class="relative max-w-2xl w-full overflow-hidden">
      <!-- Medieval container background -->
      <div class="absolute inset-0 rounded-xl bg-gradient-to-b from-gray-900/95 via-gray-900/98 to-black/95 border border-yellow-600/20"></div>

      <GoldenLine position="top" />
      <DiamondPattern opacity={0.03} class="rounded-xl" />
      <CornerOrnaments variant="curve" size="md" opacity={0.2} />

      <!-- Content -->
      <div class="relative z-10">
        <!-- Header -->
        <div class="px-4 sm:px-6 py-4 border-b border-yellow-600/20">
          <div class="flex items-center justify-center gap-3 mb-2">
            <div class="h-px w-8 sm:w-12 bg-gradient-to-r from-transparent to-yellow-500/50"></div>
            <Diamond class="w-4 h-4 sm:w-5 sm:h-5 text-yellow-500/60" fill="currentColor" />
            <div class="h-px w-8 sm:w-12 bg-gradient-to-l from-transparent to-yellow-500/50"></div>
          </div>
          <h2 id="pageTitle" class="text-xl sm:text-2xl font-bold text-yellow-500 text-center medieval-font">Specify Your Problem</h2>
        </div>

        <!-- Content -->
        <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
          <!-- Account Info -->
          <div id="accountInfo" class="relative rounded-lg p-3 sm:p-4 overflow-hidden"
               style="background: linear-gradient(to bottom, rgb(31 41 55 / 0.6), rgb(17 24 39 / 0.8)); border: 1px solid rgb(234 179 8 / 0.15);">
            <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-yellow-500/20 to-transparent"></div>
            <p class="text-sm text-gray-400">
              <span id="accountLabel">Account:</span>
              <span id="accountName" class="text-yellow-500 font-medium ml-1">Loading...</span>
            </p>
          </div>

          <!-- Password Section -->
          <div class="relative rounded-lg overflow-hidden"
               style="background: linear-gradient(to bottom, rgb(31 41 55 / 0.4), rgb(17 24 39 / 0.6)); border: 1px solid rgb(234 179 8 / 0.15);">
            <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-yellow-500/20 to-transparent"></div>
            <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-yellow-600/20">
              <h3 class="font-bold text-yellow-500 medieval-font text-sm sm:text-base" id="passwordSectionTitle">Password</h3>
            </div>
            <div class="p-3 sm:p-4 space-y-3">
              <label class="flex items-start gap-3 cursor-pointer group">
                <input type="radio" name="problem" value="forgot_password" class="mt-1 accent-yellow-500 w-4 h-4" />
                <span id="forgotPasswordOption" class="text-gray-300 group-hover:text-yellow-500 transition text-sm sm:text-base">I have forgotten my password.</span>
              </label>
              <label class="flex items-start gap-3 cursor-pointer group">
                <input type="radio" name="problem" value="hacked" class="mt-1 accent-yellow-500 w-4 h-4" />
                <span id="hackedOption" class="text-gray-300 group-hover:text-yellow-500 transition text-sm sm:text-base">My account has been hacked.</span>
              </label>
            </div>
          </div>

          <!-- Email Section -->
          <div class="relative rounded-lg overflow-hidden"
               style="background: linear-gradient(to bottom, rgb(31 41 55 / 0.4), rgb(17 24 39 / 0.6)); border: 1px solid rgb(234 179 8 / 0.15);">
            <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-yellow-500/20 to-transparent"></div>
            <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-yellow-600/20">
              <h3 class="font-bold text-yellow-500 medieval-font text-sm sm:text-base" id="emailSectionTitle">E-Mail</h3>
            </div>
            <div class="p-3 sm:p-4 space-y-1">
              <p id="emailDescription" class="text-gray-400 text-xs sm:text-sm mb-3">I want to change the email address of my account instantly:</p>
              <label class="flex items-start gap-3 cursor-pointer group">
                <input type="radio" name="problem" value="change_email_recovery" class="mt-1 accent-yellow-500 w-4 h-4" />
                <span id="recoveryKeyOption" class="text-gray-300 group-hover:text-yellow-500 transition text-sm sm:text-base">I have a recovery key.</span>
              </label>
            </div>
          </div>

          <!-- Recovery Key Section -->
          <div class="relative rounded-lg overflow-hidden"
               style="background: linear-gradient(to bottom, rgb(31 41 55 / 0.4), rgb(17 24 39 / 0.6)); border: 1px solid rgb(234 179 8 / 0.15);">
            <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-yellow-500/20 to-transparent"></div>
            <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-yellow-600/20">
              <h3 class="font-bold text-yellow-500 medieval-font text-sm sm:text-base" id="recoveryKeySectionTitle">Recovery Key</h3>
            </div>
            <div class="p-3 sm:p-4 space-y-3">
              <label class="flex items-start gap-3 cursor-pointer group">
                <input type="radio" name="problem" value="new_recovery_key" class="mt-1 accent-yellow-500 w-4 h-4" />
                <span id="newRecoveryKeyOption" class="text-gray-300 group-hover:text-yellow-500 transition text-sm sm:text-base">I need a new recovery key.</span>
              </label>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 pt-4">
            <a
              href="/lost-account"
              id="backBtn"
              class="btn-medieval btn-medieval-secondary flex-1 text-center"
            >
              <span>Volver</span>
            </a>
            <button
              type="button"
              id="continueBtn"
              disabled
              class="btn-medieval btn-medieval-primary flex-1"
            >
              <span>Continuar</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    import { t, getStoredLanguage } from "../i18n/translations";

    const lang = getStoredLanguage();

    // Check if we have account info
    const accountId = sessionStorage.getItem('lostAccountId');
    const accountName = sessionStorage.getItem('lostAccountName');
    const maskedEmail = sessionStorage.getItem('lostAccountEmail');

    if (!accountId || !accountName) {
      window.location.href = '/lost-account';
    }

    // Display account info
    const accountNameEl = document.getElementById('accountName');
    if (accountNameEl) accountNameEl.textContent = `${accountName} (${maskedEmail})`;

    // Apply translations
    const pageTitle = document.getElementById("pageTitle");
    if (pageTitle) pageTitle.textContent = t("recovery.specifyProblem", lang);

    const accountLabel = document.getElementById("accountLabel");
    if (accountLabel) accountLabel.textContent = t("recovery.account", lang) + ":";

    const passwordSectionTitle = document.getElementById("passwordSectionTitle");
    if (passwordSectionTitle) passwordSectionTitle.textContent = t("recovery.password", lang);

    const forgotPasswordOption = document.getElementById("forgotPasswordOption");
    if (forgotPasswordOption) forgotPasswordOption.textContent = t("recovery.forgotPassword", lang);

    const hackedOption = document.getElementById("hackedOption");
    if (hackedOption) hackedOption.textContent = t("recovery.accountHacked", lang);

    const emailSectionTitle = document.getElementById("emailSectionTitle");
    if (emailSectionTitle) emailSectionTitle.textContent = t("recovery.email", lang);

    const emailDescription = document.getElementById("emailDescription");
    if (emailDescription) emailDescription.textContent = t("recovery.changeEmailInstantly", lang);

    const recoveryKeyOption = document.getElementById("recoveryKeyOption");
    if (recoveryKeyOption) recoveryKeyOption.textContent = t("recovery.haveRecoveryKey", lang);

    const recoveryKeySectionTitle = document.getElementById("recoveryKeySectionTitle");
    if (recoveryKeySectionTitle) recoveryKeySectionTitle.textContent = t("recovery.recoveryKey", lang);

    const newRecoveryKeyOption = document.getElementById("newRecoveryKeyOption");
    if (newRecoveryKeyOption) newRecoveryKeyOption.textContent = t("recovery.needNewRecoveryKey", lang);

    const backBtn = document.getElementById("backBtn");
    if (backBtn) {
      const span = backBtn.querySelector('span');
      if (span) span.textContent = t("common.back", lang);
    }

    const continueBtn = document.getElementById("continueBtn");
    if (continueBtn) {
      const span = continueBtn.querySelector('span');
      if (span) span.textContent = t("recovery.continue", lang);
    }

    // Enable continue button when a radio is selected
    const radios = document.querySelectorAll('input[name="problem"]');
    radios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (continueBtn) (continueBtn as HTMLButtonElement).disabled = false;
      });
    });

    // Handle continue button click
    continueBtn?.addEventListener('click', () => {
      const selectedOption = document.querySelector('input[name="problem"]:checked') as HTMLInputElement;
      if (!selectedOption) return;

      const problem = selectedOption.value;
      sessionStorage.setItem('recoveryProblem', problem);

      // Redirect based on problem type
      switch (problem) {
        case 'forgot_password':
        case 'hacked':
          // For password issues, go to recovery key verification
          window.location.href = '/recovery-verify';
          break;
        case 'change_email_recovery':
          // For email change with recovery key
          window.location.href = '/recovery-verify?type=email';
          break;
        case 'new_recovery_key':
          // For getting new recovery key (requires email verification)
          window.location.href = '/recovery-new-key';
          break;
        default:
          window.location.href = '/recovery-verify';
      }
    });
  </script>
</Layout>
