---
import Layout from "@layouts/Layout.astro";
---

<Layout title="Informacion del personaje">
  <section class="page-container flex justify-center">
    <div class="max-w-2xl w-full mx-auto">
      <!-- Loading State -->
      <div id="loadingState" class="text-center py-12">
        <div class="text-gray-400" data-i18n="character.loadingInfo">Cargando informacion del personaje...</div>
      </div>

      <!-- Error State -->
      <div id="errorState" class="hidden bg-black/30 border border-red-500/50 backdrop-blur-md rounded-lg shadow-xl p-4 sm:p-6 md:p-8 text-center">
        <h3 id="errorTitle" class="text-lg sm:text-xl font-bold text-red-400 mb-2">Personaje no encontrado</h3>
        <p id="errorMessage" class="text-sm sm:text-base text-gray-400 mb-6">No se encontro ningun personaje con ese nombre.</p>
        <a href="/" class="inline-block px-4 sm:px-6 py-2 sm:py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-lg transition text-sm sm:text-base" data-i18n="common.backHome">
          Volver al inicio
        </a>
      </div>

      <!-- Character Info -->
      <div id="characterInfo" class="hidden space-y-6">
        <!-- Info Card -->
        <div class="bg-black/30 border border-white/30 backdrop-blur-md rounded-lg shadow-xl p-4 sm:p-6 md:p-8">
          <!-- Header -->
          <div class="text-center mb-4 sm:mb-6 pb-4 sm:pb-6 border-b border-white/10">
            <h1 id="charName" class="text-2xl sm:text-3xl font-bold text-yellow-500"></h1>
            <span id="charGM" class="hidden inline-block mt-2 px-3 py-1 bg-purple-600 text-white text-sm font-bold rounded-full" data-i18n="character.gameMaster">GameMaster</span>
          </div>

          <!-- Info Table -->
          <div class="space-y-3">
            <div class="flex justify-between py-2 border-b border-white/10">
              <span class="text-gray-400" data-i18n="character.sex">Sexo</span>
              <span id="charSex" class="text-white font-semibold"></span>
            </div>
            <div class="flex justify-between py-2 border-b border-white/10">
              <span class="text-gray-400" data-i18n="character.vocation">Vocacion</span>
              <span id="charVocation" class="text-white font-semibold"></span>
            </div>
            <div class="flex justify-between py-2 border-b border-white/10">
              <span class="text-gray-400" data-i18n="character.level">Nivel</span>
              <span id="charLevel" class="text-white font-semibold"></span>
            </div>
            <div class="flex justify-between py-2">
              <span class="text-gray-400" data-i18n="character.residence">Residencia</span>
              <span id="charTown" class="text-white font-semibold"></span>
            </div>
          </div>
        </div>

        <!-- Deaths Card -->
        <div id="deathsCard" class="bg-black/30 border border-white/30 backdrop-blur-md rounded-lg shadow-xl p-4 sm:p-6 md:p-8">
          <h2 class="text-lg sm:text-xl font-bold text-red-400 mb-4" data-i18n="character.lastDeaths">Ultimas Muertes</h2>
          <div id="deathsList" class="space-y-3">
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { t, getStoredLanguage } from '../i18n/translations';

  const API_URL = import.meta.env.PUBLIC_API_URL;
  const lang = getStoredLanguage();

  const loadingState = document.getElementById("loadingState")!;
  const errorState = document.getElementById("errorState")!;
  const characterInfo = document.getElementById("characterInfo")!;
  const errorTitle = document.getElementById("errorTitle")!;
  const errorMessage = document.getElementById("errorMessage")!;
  const deathsCard = document.getElementById("deathsCard")!;
  const deathsList = document.getElementById("deathsList")!;

  // Apply translations to static elements
  function applyTranslations() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (key) {
        el.textContent = t(key, lang);
      }
    });
  }

  applyTranslations();

  function formatDeathTime(timestamp: number): string {
    const date = new Date(timestamp * 1000);
    const localeMap: Record<string, string> = { es: 'es-ES', en: 'en-US', pt: 'pt-BR' };
    return date.toLocaleDateString(localeMap[lang] || 'es-ES', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function showError(title: string, message: string) {
    loadingState.classList.add("hidden");
    characterInfo.classList.add("hidden");
    errorState.classList.remove("hidden");
    errorTitle.textContent = title;
    errorMessage.textContent = message;
  }

  function showCharacter(character: any) {
    loadingState.classList.add("hidden");
    errorState.classList.add("hidden");
    characterInfo.classList.remove("hidden");

    document.getElementById("charName")!.textContent = character.name;
    document.getElementById("charSex")!.textContent = character.sexName;
    document.getElementById("charVocation")!.textContent = character.vocationName;
    document.getElementById("charLevel")!.textContent = character.level.toString();
    document.getElementById("charTown")!.textContent = character.townName;

    // Show Game Master badge
    if (character.isGameMaster) {
      document.getElementById("charGM")!.classList.remove("hidden");
    }

    // Show deaths
    if (character.deaths && character.deaths.length > 0) {
      const diedAtLevel = t('character.diedAtLevel', lang);
      const byText = t('character.by', lang);

      deathsList.innerHTML = character.deaths.map((death: any) => `
        <div class="bg-black/20 rounded-lg p-4 border-l-4 border-red-500">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-white">
                ${diedAtLevel} <span class="font-bold text-yellow-400">${death.level}</span>
                ${byText} <span class="font-bold ${death.isPlayer ? 'text-red-400' : 'text-orange-400'}">${death.killedBy}</span>
              </p>
              <p class="text-gray-500 text-sm mt-1">${formatDeathTime(death.time)}</p>
            </div>
          </div>
        </div>
      `).join('');
    } else {
      deathsList.innerHTML = `<p class="text-gray-400 text-center py-4">${t('character.noDeaths', lang)}</p>`;
    }
  }

  async function loadCharacter() {
    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('name');

    if (!name) {
      showError(t('character.noNameSpecified', lang), t('character.noNameMessage', lang));
      return;
    }

    try {
      const response = await fetch(`${API_URL}/api/characters/search?name=${encodeURIComponent(name)}`, {
        credentials: 'include'
      });

      const data = await response.json();

      if (!response.ok) {
        showError(t('character.notFound', lang), data.error || t('character.notFoundMessage', lang));
        return;
      }

      if (data.success && data.character) {
        showCharacter(data.character);
      } else {
        showError(t('common.error', lang), t('character.unexpectedError', lang));
      }
    } catch (error) {
      console.error("Error loading character:", error);
      showError(t('character.connectionError', lang), t('character.connectionErrorMessage', lang));
    }
  }

  loadCharacter();
</script>
