---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';

const { slug } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';

let articleData;

try {
  const response = await fetch(`${API_URL}/api/wiki/articles/${slug}`);
  articleData = await response.json();

  if (!articleData.success) {
    return Astro.redirect('/wiki');
  }
} catch (error) {
  console.error('Error fetching article:', error);
  return Astro.redirect('/wiki');
}

const { article } = articleData;
---

<Layout title={article.title}>
  <div class="container mx-auto px-4 py-8 max-w-5xl">
    <div class="flex gap-8">
      <!-- Sidebar -->
      <aside class="w-64 hidden lg:block">
        <div class="sticky top-4">
          <a href="/wiki" class="btn btn-ghost btn-sm mb-4">‚Üê Todas las categor√≠as</a>

          {article.category_name && (
            <div class="mb-4">
              <h3 class="font-semibold mb-2">{article.category_name}</h3>
            </div>
          )}
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1">
        <div class="text-sm breadcrumbs mb-4">
          <ul>
            <li><a href="/">Inicio</a></li>
            <li><a href="/wiki">Wiki</a></li>
            {article.category_name && (
              <li><a href={`/wiki/${article.category_slug}`}>{article.category_name}</a></li>
            )}
            <li>{article.title}</li>
          </ul>
        </div>

        <article class="card bg-base-100 shadow-xl">
          <div class="card-body p-8">
            <h1 class="text-4xl font-bold mb-4">{article.title}</h1>

            <div class="flex items-center gap-4 text-sm text-base-content/60 mb-6 pb-6 border-b border-base-300">
              <span>‚úçÔ∏è {article.author_name}</span>
              <span>üëÅÔ∏è {article.views_count} vistas</span>
              <span>{new Date(article.updated_at).toLocaleDateString('es-ES')}</span>
            </div>

            <div class="prose max-w-none" set:html={article.content}></div>
          </div>
        </article>
      </main>
    </div>
  </div>
</Layout>

<style>
  .prose {
    color: inherit;
  }

  .prose h1, .prose h2, .prose h3, .prose h4 {
    color: inherit;
    font-weight: bold;
  }

  .prose a {
    color: hsl(var(--p));
  }
</style>
