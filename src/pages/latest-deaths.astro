---
import Layout from "@layouts/Layout.astro";
import DiamondPattern from "../components/ui/DiamondPattern.astro";
import GoldenLine from "../components/ui/GoldenLine.astro";
import CornerOrnaments from "../components/ui/CornerOrnaments.astro";
import { Skull, AlertTriangle, Heart, ChevronLeft } from '@lucide/astro';
---

<Layout
  title="Últimas Muertes"
  description="Registro de las últimas 100 muertes en Mystovia. Consulta quién murió, a manos de quién y cuándo en el servidor."
  keywords="muertes mystovia, deaths tibia, quien murio, registro muertes, pvp deaths"
>
  <section class="page-container">
    <!-- Header -->
    <header class="text-center mb-8">
      <div class="flex items-center justify-center gap-3 mb-2">
        <div class="h-px w-16 bg-gradient-to-r from-transparent to-red-500/50"></div>
        <Skull class="w-6 h-6 text-red-500/60" />
        <div class="h-px w-16 bg-gradient-to-l from-transparent to-red-500/50"></div>
      </div>
      <h1 id="deathsTitle" class="text-3xl md:text-4xl font-bold text-red-500 medieval-font mb-2">Últimas 100 Muertes</h1>
      <p id="deathsSubtitle" class="text-gray-400">Registro de las caídas más recientes en Mystovia</p>
    </header>

    <!-- Results Info -->
    <div class="flex justify-between items-center mb-4 text-sm text-gray-400">
      <span id="lastUpdate">Última actualización: --</span>
      <span id="resultsCount">Muertes: --</span>
    </div>

    <!-- Table -->
    <div class="relative rounded-xl overflow-hidden"
         style="background: linear-gradient(to bottom, rgb(31 41 55 / 0.6), rgb(17 24 39 / 0.8)); border: 1px solid rgb(220 38 38 / 0.15);">
      <GoldenLine position="top" color="red" opacity={0.3} />

      <!-- Diamond pattern overlay -->
      <DiamondPattern opacity={0.02} class="rounded-xl" />

      <!-- Corner ornaments -->
      <CornerOrnaments variant="curve" size="lg" opacity={0.15} color="red" offset={2} />

      <!-- Table Header - Desktop -->
      <div class="hidden sm:grid grid-cols-12 gap-2 px-4 py-3 text-sm text-red-500 font-semibold border-b border-red-600/20 bg-black/20 relative z-10">
        <div class="col-span-1 text-center">#</div>
        <div id="deathsHeaderPlayer" class="col-span-3">Jugador</div>
        <div id="deathsHeaderVocation" class="col-span-2">Vocación</div>
        <div id="deathsHeaderLevel" class="col-span-1 text-center">Nivel</div>
        <div id="deathsHeaderKilledBy" class="col-span-3">Killed By</div>
        <div id="deathsHeaderDate" class="col-span-2 text-right">Fecha</div>
      </div>
      <!-- Table Header - Mobile -->
      <div class="sm:hidden px-4 py-3 text-sm text-red-500 font-semibold border-b border-red-600/20 bg-black/20 flex justify-between relative z-10">
        <span id="deathsMobilePlayer">Jugador</span>
        <span id="deathsMobileKilledBy">Killed By</span>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="py-12 text-center relative z-10">
        <div class="w-8 h-8 border-2 border-red-500/30 border-t-red-500 rounded-full animate-spin mx-auto mb-3"></div>
        <p id="deathsLoadingText" class="text-gray-400">Cargando muertes...</p>
      </div>

      <!-- Error State -->
      <div id="errorState" class="hidden py-12 text-center relative z-10">
        <AlertTriangle class="w-12 h-12 mx-auto text-red-500/50 mb-3" />
        <p id="deathsErrorText" class="text-red-400">Error al cargar los datos</p>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden py-12 text-center relative z-10">
        <Heart class="w-12 h-12 mx-auto text-red-500/30 mb-3" />
        <p id="deathsEmptyText" class="text-gray-400">No hay muertes registradas</p>
      </div>

      <!-- Deaths List -->
      <div id="deathsList" class="hidden relative z-10">
        <!-- Deaths will be inserted here -->
      </div>
    </div>

    <!-- Back button -->
    <div class="mt-6 text-center">
      <a href="/" class="inline-flex items-center gap-2 text-gray-400 hover:text-red-400 transition-colors">
        <ChevronLeft class="w-4 h-4" />
        <span id="deathsBackHome">Volver al inicio</span>
      </a>
    </div>
  </section>
</Layout>

<script>
  import { t, getStoredLanguage } from '../i18n/translations';

  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3301';

  interface Death {
    id: number;
    date: number;
    level: number;
    player: {
      id: number;
      name: string;
      vocation: string;
    };
    killedBy: string;
    isPlayerKill: boolean;
  }

  interface DeathsResponse {
    deaths: Death[];
    total: number;
    lastUpdate?: string;
  }

  function formatDate(timestamp: number): string {
    const date = new Date(timestamp * 1000);
    return date.toLocaleString('es-ES', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  async function loadDeaths() {
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const emptyState = document.getElementById('emptyState');
    const deathsList = document.getElementById('deathsList');
    const lastUpdate = document.getElementById('lastUpdate');
    const resultsCount = document.getElementById('resultsCount');

    // Show loading
    loadingState?.classList.remove('hidden');
    errorState?.classList.add('hidden');
    emptyState?.classList.add('hidden');
    deathsList?.classList.add('hidden');

    try {
      const response = await fetch(`${API_URL}/api/deaths/latest?limit=100`);

      if (!response.ok) throw new Error('Failed to fetch');

      const data: DeathsResponse = await response.json();

      loadingState?.classList.add('hidden');

      if (!data.deaths || data.deaths.length === 0) {
        emptyState?.classList.remove('hidden');
        return;
      }

      // Update info
      if (lastUpdate) {
        lastUpdate.textContent = `Última actualización: ${data.lastUpdate || 'Ahora'}`;
      }
      if (resultsCount) {
        resultsCount.textContent = `Muertes: ${data.total}`;
      }

      // Render deaths
      if (deathsList) {
        deathsList.innerHTML = data.deaths.map((death, index) => {
          const isPlayerKill = death.isPlayerKill;

          return `
            <div class="block sm:grid sm:grid-cols-12 gap-2 px-4 py-3 border-b border-red-600/10 transition-all duration-300 hover:bg-red-500/5"
                 style="background: linear-gradient(to right, rgba(220, 38, 38, ${0.03 - index * 0.0003}), transparent);">
              <!-- Desktop Layout -->
              <div class="hidden sm:block col-span-1 text-center text-gray-500">${index + 1}</div>
              <div class="hidden sm:block col-span-3">
                <a href="/character-information?name=${encodeURIComponent(death.player.name)}" class="text-red-400 hover:text-red-300 font-semibold transition-colors truncate block">
                  ${death.player.name}
                </a>
              </div>
              <div class="hidden sm:block col-span-2 text-gray-400 text-sm truncate">${death.player.vocation}</div>
              <div class="hidden sm:block col-span-1 text-center text-white">${death.level}</div>
              <div class="hidden sm:block col-span-3 truncate">
                <span class="${isPlayerKill ? 'text-yellow-500' : 'text-gray-300'} font-medium">${death.killedBy}</span>
                ${isPlayerKill ? '<span class="ml-1 text-xs text-yellow-500/60">(PvP)</span>' : ''}
              </div>
              <div class="hidden sm:block col-span-2 text-right text-gray-500 text-sm">${formatDate(death.date)}</div>

              <!-- Mobile Layout -->
              <div class="sm:hidden">
                <div class="flex justify-between items-start mb-1">
                  <a href="/character-information?name=${encodeURIComponent(death.player.name)}" class="text-red-400 hover:text-red-300 font-semibold transition-colors">
                    ${death.player.name}
                  </a>
                  <span class="${isPlayerKill ? 'text-yellow-500' : 'text-gray-300'} text-sm font-medium truncate max-w-[120px]">${death.killedBy}</span>
                </div>
                <div class="flex justify-between items-center text-xs text-gray-500">
                  <span>Lvl ${death.level} ${death.player.vocation}</span>
                  <span>${formatDate(death.date)}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');

        deathsList.classList.remove('hidden');
      }

    } catch (error) {
      console.error('Error loading deaths:', error);
      loadingState?.classList.add('hidden');
      errorState?.classList.remove('hidden');
    }
  }

  function applyTranslations() {
    const lang = getStoredLanguage();

    const deathsTitle = document.getElementById('deathsTitle');
    if (deathsTitle) deathsTitle.textContent = t('pages.deaths.title', lang);

    const deathsSubtitle = document.getElementById('deathsSubtitle');
    if (deathsSubtitle) deathsSubtitle.textContent = t('pages.deaths.subtitle', lang);

    const deathsHeaderPlayer = document.getElementById('deathsHeaderPlayer');
    if (deathsHeaderPlayer) deathsHeaderPlayer.textContent = t('pages.deaths.player', lang);

    const deathsHeaderVocation = document.getElementById('deathsHeaderVocation');
    if (deathsHeaderVocation) deathsHeaderVocation.textContent = t('pages.deaths.vocation', lang);

    const deathsHeaderLevel = document.getElementById('deathsHeaderLevel');
    if (deathsHeaderLevel) deathsHeaderLevel.textContent = t('pages.deaths.level', lang);

    const deathsHeaderKilledBy = document.getElementById('deathsHeaderKilledBy');
    if (deathsHeaderKilledBy) deathsHeaderKilledBy.textContent = t('pages.deaths.killedBy', lang);

    const deathsHeaderDate = document.getElementById('deathsHeaderDate');
    if (deathsHeaderDate) deathsHeaderDate.textContent = t('pages.deaths.date', lang);

    const deathsMobilePlayer = document.getElementById('deathsMobilePlayer');
    if (deathsMobilePlayer) deathsMobilePlayer.textContent = t('pages.deaths.player', lang);

    const deathsMobileKilledBy = document.getElementById('deathsMobileKilledBy');
    if (deathsMobileKilledBy) deathsMobileKilledBy.textContent = t('pages.deaths.killedBy', lang);

    const deathsLoadingText = document.getElementById('deathsLoadingText');
    if (deathsLoadingText) deathsLoadingText.textContent = t('pages.deaths.loading', lang);

    const deathsErrorText = document.getElementById('deathsErrorText');
    if (deathsErrorText) deathsErrorText.textContent = t('pages.deaths.error', lang);

    const deathsEmptyText = document.getElementById('deathsEmptyText');
    if (deathsEmptyText) deathsEmptyText.textContent = t('pages.deaths.empty', lang);

    const deathsBackHome = document.getElementById('deathsBackHome');
    if (deathsBackHome) deathsBackHome.textContent = t('pages.deaths.backHome', lang);
  }

  loadDeaths();
  applyTranslations();
  document.addEventListener('astro:page-load', () => {
    loadDeaths();
    applyTranslations();
  });
</script>
