---
import Layout from "../layouts/Layout.astro";
import Input from "@ui/Input.astro";
import ErrorMessage from "@ui/ErrorMessage.astro";
import SubmitBtn from "@ui/SubmitBtn.astro";
---

<Layout title="Recuperar Contraseña | Mystovia">
  <section class="grow z-100 flex items-center justify-center min-h-screen py-12 px-4">
    <div class="relative max-w-md w-full overflow-hidden">
      <!-- Medieval container background -->
      <div class="absolute inset-0 rounded-xl bg-gradient-to-b from-gray-900/95 via-gray-900/98 to-black/95 border border-yellow-600/20"></div>

      <!-- Top golden line -->
      <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-yellow-500/50 to-transparent"></div>

      <!-- Diamond pattern overlay -->
      <div class="absolute inset-0 opacity-[0.03] pointer-events-none rounded-xl" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M30 0L60 30L30 60L0 30z\' fill=\'%23d4af37\' fill-opacity=\'0.4\'/%3E%3C/svg%3E'); background-size: 30px 30px;"></div>

      <!-- Corner ornaments -->
      <div class="absolute top-2 left-2 w-8 h-8 opacity-20 pointer-events-none">
        <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
          <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
        </svg>
      </div>
      <div class="absolute top-2 right-2 w-8 h-8 opacity-20 pointer-events-none" style="transform: scaleX(-1);">
        <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
          <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
        </svg>
      </div>
      <div class="absolute bottom-2 left-2 w-8 h-8 opacity-20 pointer-events-none" style="transform: scaleY(-1);">
        <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
          <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
        </svg>
      </div>
      <div class="absolute bottom-2 right-2 w-8 h-8 opacity-20 pointer-events-none" style="transform: scale(-1);">
        <svg viewBox="0 0 100 100" fill="none" class="w-full h-full text-yellow-500">
          <path d="M0 0 L40 0 Q0 0 0 40 Z" fill="currentColor"/>
        </svg>
      </div>

      <!-- Form content -->
      <form
        id="forgotPasswordForm"
        class="relative z-10 p-8 space-y-6"
      >
        <!-- Title with decorative elements -->
        <div class="text-center mb-8">
          <div class="flex items-center justify-center gap-3 mb-2">
            <div class="h-px w-12 bg-gradient-to-r from-transparent to-yellow-500/50"></div>
            <svg class="w-5 h-5 text-yellow-500/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
            </svg>
            <div class="h-px w-12 bg-gradient-to-l from-transparent to-yellow-500/50"></div>
          </div>
          <h2 id="forgotTitle" class="text-3xl font-bold text-white medieval-font">Recuperar contraseña</h2>
          <p id="forgotDescription" class="text-center text-sm text-gray-400 mt-3">
            Ingresa tu email y te enviaremos un enlace para restablecer tu contraseña.
          </p>
        </div>

        <Input
          id="email"
          label="Email"
          type="email"
          placeholder="you@email.com"
          required
        />

        <div id="errorContainer" class="hidden">
          <ErrorMessage message="" visible={false} />
        </div>

        <div id="successMessage" class="hidden p-4 bg-green-500/20 border border-green-500/50 rounded-lg text-green-400 text-sm text-center">
          <span id="successText">Si el email existe en nuestro sistema, recibirás un enlace de recuperación.</span>
        </div>

        <SubmitBtn label="ENVIAR ENLACE" id="submitBtn" />

        <!-- Decorative divider -->
        <div class="flex items-center gap-3 pt-2">
          <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent"></div>
        </div>

        <p id="backToLoginText" class="text-center text-sm text-gray-400 pt-2">
          <a href="/login" id="loginLink" class="text-yellow-500 hover:text-yellow-400 font-medium">
            Volver al inicio de sesión
          </a>
        </p>
      </form>
    </div>
  </section>

  <script>
    import { forgotPassword } from "../utils/api";
    import { t, getStoredLanguage } from "../i18n/translations";

    const lang = getStoredLanguage();

    // Apply translations
    const forgotTitle = document.getElementById("forgotTitle");
    if (forgotTitle) forgotTitle.textContent = t("auth.forgotPassword", lang);

    const forgotDescription = document.getElementById("forgotDescription");
    if (forgotDescription) forgotDescription.textContent = t("auth.forgotPasswordDescription", lang);

    const submitBtn = document.getElementById("submitBtn");
    if (submitBtn) submitBtn.textContent = t("auth.sendResetLink", lang);

    const loginLink = document.getElementById("loginLink");
    if (loginLink) loginLink.textContent = t("auth.backToLogin", lang);

    const successText = document.getElementById("successText");
    if (successText) successText.textContent = t("auth.resetEmailSent", lang);

    const form = document.getElementById("forgotPasswordForm") as HTMLFormElement & {
      email: HTMLInputElement;
    };

    const successMessage = document.getElementById("successMessage");
    const errorContainer = document.getElementById("errorContainer");

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = form.email.value;
      const submitButton = document.getElementById("submitBtn") as HTMLButtonElement;

      // Disable button and show loading
      submitButton.disabled = true;
      submitButton.textContent = t("common.loading", lang) || "Enviando...";

      try {
        const res = await forgotPassword(email);

        if (res.success) {
          // Show success message
          successMessage?.classList.remove("hidden");
          errorContainer?.classList.add("hidden");
          form.reset();
        } else {
          // Show error
          errorContainer?.classList.remove("hidden");
          successMessage?.classList.add("hidden");
          const errorEl = errorContainer?.querySelector("p");
          if (errorEl) errorEl.textContent = res.error || t("common.error", lang);
        }
      } catch (error) {
        console.error("Forgot password error:", error);
        errorContainer?.classList.remove("hidden");
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = t("auth.sendResetLink", lang);
      }
    });
  </script>
</Layout>
