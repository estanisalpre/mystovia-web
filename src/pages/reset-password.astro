---
import Layout from "../layouts/Layout.astro";
import Input from "@ui/Input.astro";
import ErrorMessage from "@ui/ErrorMessage.astro";
import SubmitBtn from "@ui/SubmitBtn.astro";
---

<Layout
  title="Restablecer Contraseña"
  description="Restablece tu contraseña de Mystovia. Crea una nueva contraseña segura para tu cuenta."
  keywords="restablecer contraseña mystovia, nueva contraseña, cambiar password tibia"
>
  <section class="grow z-100 flex items-center justify-center min-h-screen py-12 px-4">
    <!-- Loading State -->
    <div id="loadingState" class="max-w-md w-full backdrop-blur-md border border-white/30 bg-black/30 rounded-lg shadow-xl p-8 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 mx-auto mb-4"></div>
      <p id="loadingText" class="text-gray-400">Verificando enlace...</p>
    </div>

    <!-- Invalid Token State -->
    <div id="invalidState" class="hidden max-w-md w-full backdrop-blur-md border border-white/30 bg-black/30 rounded-lg shadow-xl p-8 text-center">
      <div class="text-red-500 text-6xl mb-4">✕</div>
      <h2 id="invalidTitle" class="text-2xl font-bold mb-4">Enlace inválido</h2>
      <p id="invalidDescription" class="text-gray-400 mb-6">
        Este enlace de recuperación ha expirado o no es válido. Por favor, solicita un nuevo enlace.
      </p>
      <a href="/forgot-password" id="requestNewLink" class="inline-block px-6 py-3 bg-yellow-500 text-black font-bold rounded hover:bg-yellow-400 transition">
        Solicitar nuevo enlace
      </a>
    </div>

    <!-- Reset Form -->
    <form
      id="resetPasswordForm"
      class="hidden max-w-md w-full backdrop-blur-md border border-white/30 bg-black/30 rounded-lg shadow-xl p-8 space-y-6"
    >
      <h2 id="resetTitle" class="text-3xl font-bold text-center mb-2">Nueva contraseña</h2>
      <p id="resetDescription" class="text-center text-sm text-gray-400 mb-6">
        Ingresa tu nueva contraseña. Debe tener al menos 8 caracteres.
      </p>

      <Input
        id="newPassword"
        label="Nueva contraseña"
        type="password"
        placeholder="••••••••"
        required
      />

      <Input
        id="confirmPassword"
        label="Confirmar contraseña"
        type="password"
        placeholder="••••••••"
        required
      />

      <input type="hidden" id="resetToken" name="token" />

      <div id="errorContainer" class="hidden">
        <ErrorMessage message="" visible={false} />
      </div>

      <SubmitBtn label="RESTABLECER CONTRASEÑA" id="submitBtn" />
    </form>

    <!-- Success State -->
    <div id="successState" class="hidden max-w-md w-full backdrop-blur-md border border-white/30 bg-black/30 rounded-lg shadow-xl p-8 text-center">
      <div class="text-green-500 text-6xl mb-4">✓</div>
      <h2 id="successTitle" class="text-2xl font-bold mb-4">¡Contraseña actualizada!</h2>
      <p id="successDescription" class="text-gray-400 mb-6">
        Tu contraseña ha sido restablecida correctamente. Ya puedes iniciar sesión con tu nueva contraseña.
      </p>
      <a href="/login" id="goToLogin" class="inline-block px-6 py-3 bg-yellow-500 text-black font-bold rounded hover:bg-yellow-400 transition">
        Ir a iniciar sesión
      </a>
    </div>
  </section>

  <script>
    import { resetPassword, verifyResetToken } from "../utils/api";
    import { t, getStoredLanguage } from "../i18n/translations";

    const lang = getStoredLanguage();

    // Get elements
    const loadingState = document.getElementById("loadingState");
    const invalidState = document.getElementById("invalidState");
    const resetForm = document.getElementById("resetPasswordForm");
    const successState = document.getElementById("successState");
    const errorContainer = document.getElementById("errorContainer");

    // Apply translations
    const loadingText = document.getElementById("loadingText");
    if (loadingText) loadingText.textContent = t("auth.verifyingLink", lang);

    const invalidTitle = document.getElementById("invalidTitle");
    if (invalidTitle) invalidTitle.textContent = t("auth.invalidLink", lang);

    const invalidDescription = document.getElementById("invalidDescription");
    if (invalidDescription) invalidDescription.textContent = t("auth.invalidLinkDescription", lang);

    const requestNewLink = document.getElementById("requestNewLink");
    if (requestNewLink) requestNewLink.textContent = t("auth.requestNewLink", lang);

    const resetTitle = document.getElementById("resetTitle");
    if (resetTitle) resetTitle.textContent = t("auth.newPassword", lang);

    const resetDescription = document.getElementById("resetDescription");
    if (resetDescription) resetDescription.textContent = t("auth.newPasswordDescription", lang);

    const submitBtn = document.getElementById("submitBtn");
    if (submitBtn) submitBtn.textContent = t("auth.resetPassword", lang);

    const successTitle = document.getElementById("successTitle");
    if (successTitle) successTitle.textContent = t("auth.passwordUpdated", lang);

    const successDescription = document.getElementById("successDescription");
    if (successDescription) successDescription.textContent = t("auth.passwordUpdatedDescription", lang);

    const goToLogin = document.getElementById("goToLogin");
    if (goToLogin) goToLogin.textContent = t("auth.goToLogin", lang);

    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");

    async function verifyToken() {
      if (!token) {
        showInvalidState();
        return;
      }

      try {
        const result = await verifyResetToken(token);

        if (result.success && result.data?.valid) {
          showResetForm();
          // Store token in hidden input
          const tokenInput = document.getElementById("resetToken") as HTMLInputElement;
          if (tokenInput) tokenInput.value = token;
        } else {
          showInvalidState();
        }
      } catch (error) {
        console.error("Token verification error:", error);
        showInvalidState();
      }
    }

    function showInvalidState() {
      loadingState?.classList.add("hidden");
      invalidState?.classList.remove("hidden");
      resetForm?.classList.add("hidden");
      successState?.classList.add("hidden");
    }

    function showResetForm() {
      loadingState?.classList.add("hidden");
      invalidState?.classList.add("hidden");
      resetForm?.classList.remove("hidden");
      successState?.classList.add("hidden");
    }

    function showSuccessState() {
      loadingState?.classList.add("hidden");
      invalidState?.classList.add("hidden");
      resetForm?.classList.add("hidden");
      successState?.classList.remove("hidden");
    }

    // Verify token on page load
    verifyToken();

    // Handle form submission
    const form = document.getElementById("resetPasswordForm") as HTMLFormElement & {
      newPassword: HTMLInputElement;
      confirmPassword: HTMLInputElement;
    };

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const newPassword = form.newPassword.value;
      const confirmPassword = form.confirmPassword.value;
      const submitButton = document.getElementById("submitBtn") as HTMLButtonElement;

      // Validate passwords match
      if (newPassword !== confirmPassword) {
        showError(t("account.passwordsDontMatch", lang));
        return;
      }

      // Validate password length
      if (newPassword.length < 8) {
        showError(t("account.passwordTooShort", lang));
        return;
      }

      // Disable button and show loading
      submitButton.disabled = true;
      submitButton.textContent = t("common.loading", lang) || "Procesando...";

      try {
        const result = await resetPassword(token!, newPassword);

        if (result.success) {
          showSuccessState();
        } else {
          showError(result.error || t("common.error", lang));
        }
      } catch (error) {
        console.error("Reset password error:", error);
        showError(t("common.error", lang));
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = t("auth.resetPassword", lang);
      }
    });

    function showError(message: string) {
      errorContainer?.classList.remove("hidden");
      const errorEl = errorContainer?.querySelector("p");
      if (errorEl) errorEl.textContent = message;
    }
  </script>
</Layout>
