---
import Layout from "@layouts/Layout.astro";
import { MessagesSquare, Info, MessageCircle, Diamond } from "@lucide/astro";
import DiamondPattern from "../../components/ui/DiamondPattern.astro";
import GoldenLine from "../../components/ui/GoldenLine.astro";

// For internal SSR calls, use localhost with the same port (same Express server)
const INTERNAL_API_URL = `http://localhost:${process.env.PORT || 3301}`;

// Fetch forum categories
let categoriesData;

try {
  const response = await fetch(`${INTERNAL_API_URL}/api/forum/categories`);
  categoriesData = await response.json();
} catch (error) {
  console.error("Error fetching categories:", error);
  categoriesData = { categories: [] };
}

const categories = categoriesData?.categories || [];

// Get user
const userId = Astro.cookies.get("userId")?.value;
const userEmail = Astro.cookies.get("userEmail")?.value;
let user = null;

if (userId && userEmail) {
  try {
    // Use internal URL for SSR verification (same server, no cross-origin issues)
    const verifyResponse = await fetch(`${INTERNAL_API_URL}/api/auth/verify`, {
      headers: { Cookie: `userId=${userId}; userEmail=${userEmail}` },
    });
    if (verifyResponse.ok) {
      const data = await verifyResponse.json();
      user = data.user;
    }
  } catch (error) {
    console.error("Error verifying user:", error);
  }
}
---

<Layout title="Foro de la Comunidad | Mystovia">
  <section class="page-container">
    <!-- Header with medieval style -->
    <div class="mb-6 sm:mb-8 text-center">
      <div class="flex items-center justify-center gap-3 mb-3">
        <div class="h-px w-8 sm:w-12 bg-gradient-to-r from-transparent to-yellow-500/50"></div>
        <Diamond class="w-4 h-4 text-yellow-500/70" fill="currentColor" />
        <div class="h-px w-8 sm:w-12 bg-gradient-to-l from-transparent to-yellow-500/50"></div>
      </div>
      <div class="flex items-center justify-center gap-3 mb-3 sm:mb-4">
        <MessagesSquare class="w-6 h-6 sm:w-8 sm:h-8 text-yellow-500" />
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-yellow-500 medieval-font">Foro de la Comunidad</h1>
      </div>
      <p class="text-sm sm:text-base md:text-lg text-gray-400">
        Únete a las discusiones, comparte tus ideas y conecta con otros miembros de la comunidad.
      </p>
    </div>

    <!-- Categories -->
    {
      categories.length === 0 ? (
        <div class="text-center py-8 sm:py-12">
          <p class="text-sm sm:text-base text-gray-400">
            No hay categorías disponibles.
          </p>
        </div>
      ) : (
        <div class="space-y-3 sm:space-y-4">
          {categories.map((category: any) => (
            <a href={`/forum/category/${category.id}`}
               class="relative rounded-xl overflow-hidden p-4 sm:p-5 border border-yellow-600/20 hover:border-yellow-500/40 transition-all flex items-center justify-between gap-4 group block"
               style="background: linear-gradient(to bottom, rgb(17 24 39 / 0.9), rgb(0 0 0 / 0.85));">
              <DiamondPattern opacity={0.03} class="rounded-xl" />
              <GoldenLine position="top" opacity={0.4} class="group-hover:opacity-60 transition-all" />

              <div class="flex-1 relative z-10">
                <h2 class="text-base sm:text-lg md:text-xl font-bold text-yellow-500 mb-1 group-hover:translate-x-1 transition-transform">
                  {category.name}
                </h2>
                {category.description && (
                  <p class="text-xs sm:text-sm text-gray-400">{category.description}</p>
                )}
              </div>

              <div class="relative z-10 flex items-center gap-2 bg-yellow-500/10 border border-yellow-500/30 rounded-lg px-3 py-2">
                <MessageCircle class="w-4 h-4 text-yellow-500" />
                <div class="text-center">
                  <div class="text-lg sm:text-xl font-bold text-yellow-500">{category.topics_count || 0}</div>
                  <div class="text-xs text-gray-400">Temas</div>
                </div>
              </div>
            </a>
          ))}
        </div>
      )
    }

    <!-- Info for non-logged users -->
    {
      !user && (
        <div class="relative rounded-xl overflow-hidden p-3 sm:p-4 mt-6 border border-blue-600/30"
             style="background: linear-gradient(to right, rgb(30 58 138 / 0.3), rgb(17 24 39 / 0.9));">
          <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-blue-500/50 via-transparent to-transparent"></div>
          <div class="flex items-start gap-3 relative z-10">
            <Info class="w-5 h-5 text-blue-400 shrink-0 mt-0.5" />
            <p class="text-xs sm:text-sm text-blue-200">
              <a href="/login" class="text-yellow-500 hover:text-yellow-400 font-semibold">Inicia sesión</a> para crear temas y participar en las discusiones.
            </p>
          </div>
        </div>
      )
    }
  </section>
</Layout>
