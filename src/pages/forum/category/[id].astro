---
export const prerender = false;

import Layout from '../../../layouts/Layout.astro';
import Pagination from '../../../components/Pagination.astro';
import { hasPermission } from '../../../utils/permissions';
import { Plus, User, MessageSquare, Eye, Calendar, Pin, Lock, ChevronRight, Home, ThumbsUp } from '@lucide/astro';
import DiamondPattern from "../../../components/ui/DiamondPattern.astro";
import GoldenLine from "../../../components/ui/GoldenLine.astro";

// Helper function to format vote count
function formatVotes(votes: number): string {
  if (votes > 0) return `+${votes}`;
  if (votes < 0) return `${votes}`;
  return '0';
}

const { id } = Astro.params;
const page = parseInt(Astro.url.searchParams.get('page') || '1');

// For internal SSR calls, use localhost with the same port (same Express server)
const INTERNAL_API_URL = `http://localhost:${process.env.PORT || 3301}`;

// Get user from cookies and verify with API
const userId = Astro.cookies.get('userId')?.value;
const userEmail = Astro.cookies.get('userEmail')?.value;
let user = null;

if (userId && userEmail) {
  try {
    // Use internal URL for SSR verification (same server, no cross-origin issues)
    const verifyResponse = await fetch(`${INTERNAL_API_URL}/api/auth/verify`, {
      method: 'GET',
      headers: {
        'Cookie': `userId=${userId}; userEmail=${userEmail}`,
        'Content-Type': 'application/json'
      }
    });
    if (verifyResponse.ok) {
      const data = await verifyResponse.json();
      if (data.success && data.user) {
        user = data.user;
      }
    }
  } catch (error) {
    console.error('Error verifying user:', error);
  }
}

const canWriteForum = hasPermission(user?.groupId, 'write_forum');

// Fetch topics
let topicsData;
let categoryData;

try {
  const [topicsResponse, categoriesResponse] = await Promise.all([
    fetch(`${INTERNAL_API_URL}/api/forum/categories/${id}/topics?page=${page}&limit=20`),
    fetch(`${INTERNAL_API_URL}/api/forum/categories`)
  ]);

  topicsData = await topicsResponse.json();
  const allCategories = await categoriesResponse.json();
  categoryData = allCategories.categories.find((c: any) => c.id === parseInt(id!));

  if (!categoryData) {
    return Astro.redirect('/forum');
  }
} catch (error) {
  console.error('Error fetching topics:', error);
  return Astro.redirect('/forum');
}

const { topics, pagination } = topicsData;
---

<Layout
  title={categoryData.name}
  description={`Temas de ${categoryData.name} en el foro de Mystovia. Participa en las discusiones de la comunidad.`}
  keywords={`foro ${categoryData.name.toLowerCase()}, categoria foro mystovia, discusiones tibia`}
>
  <section class="page-container">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-xs sm:text-sm text-gray-400 mb-4 sm:mb-6">
      <a href="/" class="hover:text-yellow-500 transition-colors flex items-center gap-1">
        <Home class="w-3 h-3" />
        <span class="forum-breadcrumb-home">Inicio</span>
      </a>
      <ChevronRight class="w-3 h-3 text-gray-600" />
      <a href="/forum" class="hover:text-yellow-500 transition-colors forum-breadcrumb-forum">Foro</a>
      <ChevronRight class="w-3 h-3 text-gray-600" />
      <span class="text-yellow-500">{categoryData.name}</span>
    </nav>

    <!-- Header -->
    <div class="relative rounded-xl overflow-hidden p-4 sm:p-6 border border-yellow-600/20 mb-6"
         style="background: linear-gradient(to bottom, rgb(17 24 39 / 0.9), rgb(0 0 0 / 0.85));">
      <DiamondPattern opacity={0.03} class="rounded-xl" />
      <GoldenLine position="top" />

      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 relative z-10">
        <div>
          <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-yellow-500 medieval-font mb-1">{categoryData.name}</h1>
          {categoryData.description && (
            <p class="text-xs sm:text-sm text-gray-400">{categoryData.description}</p>
          )}
        </div>

        {canWriteForum && (
          <a href={`/forum/new-topic?category=${id}`}
             class="flex items-center gap-2 px-4 py-2 text-xs sm:text-sm font-semibold text-black bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg hover:from-yellow-400 hover:to-yellow-500 transition-all forum-new-topic-btn">
            <Plus class="w-4 h-4" />
            <span>Nuevo Tema</span>
          </a>
        )}
      </div>
    </div>

    <!-- Topics List -->
    {topics.length === 0 ? (
      <div class="text-center py-8 sm:py-12">
        <p class="text-sm sm:text-base text-gray-400 mb-4 forum-no-topics-text">
          No hay temas en esta categoría aún.
        </p>
        {canWriteForum && (
          <a href={`/forum/new-topic?category=${id}`}
             class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold text-black bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg hover:from-yellow-400 hover:to-yellow-500 transition-all forum-create-first-btn">
            <Plus class="w-4 h-4" />
            <span>Crear el primer tema</span>
          </a>
        )}
      </div>
    ) : (
      <div class="space-y-3">
        {topics.map((topic: any) => (
          <a href={`/forum/topic/${topic.id}`}
             class="relative rounded-xl overflow-hidden p-4 border border-yellow-600/20 hover:border-yellow-500/40 transition-all flex gap-3 sm:gap-4 group block"
             style="background: linear-gradient(to bottom, rgb(17 24 39 / 0.9), rgb(0 0 0 / 0.85));">
            <!-- Top golden line -->
            <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-yellow-500/30 to-transparent group-hover:via-yellow-500/50 transition-all"></div>

            <!-- Vote Count -->
            <div class="flex flex-col items-center justify-center min-w-[50px] sm:min-w-[60px] relative z-10">
              <ThumbsUp class:list={[
                'w-4 h-4 mb-1',
                topic.total_votes > 0 && 'text-green-500',
                topic.total_votes < 0 && 'text-red-500',
                (!topic.total_votes || topic.total_votes === 0) && 'text-gray-500'
              ]} />
              <div class:list={[
                'text-xl sm:text-2xl font-bold',
                topic.total_votes > 0 && 'text-green-500',
                topic.total_votes < 0 && 'text-red-500',
                (!topic.total_votes || topic.total_votes === 0) && 'text-white'
              ]}>
                {formatVotes(topic.total_votes || 0)}
              </div>
              <div class="text-xs text-gray-500 forum-votes-label">votos</div>
            </div>

            <!-- Topic Info -->
            <div class="flex-1 relative z-10">
              <div class="flex items-center gap-2 mb-2 flex-wrap">
                {topic.is_pinned && (
                  <span class="inline-flex items-center gap-1 text-xs bg-amber-500/20 text-amber-400 px-2 py-0.5 rounded border border-amber-500/30 forum-pinned-label">
                    <Pin class="w-3 h-3" />
                    <span>Fijado</span>
                  </span>
                )}
                {topic.is_locked && (
                  <span class="inline-flex items-center gap-1 text-xs bg-red-500/20 text-red-400 px-2 py-0.5 rounded border border-red-500/30 forum-locked-label">
                    <Lock class="w-3 h-3" />
                    <span>Cerrado</span>
                  </span>
                )}
              </div>

              <h3 class="text-sm sm:text-base md:text-lg font-semibold text-white mb-1 group-hover:text-yellow-500 transition-colors">
                {topic.title}
              </h3>

              <p class="text-xs sm:text-sm text-gray-400 line-clamp-2 mb-2">
                {topic.content.replace(/<[^>]*>/g, '').substring(0, 200)}...
              </p>

              <div class="flex items-center gap-3 sm:gap-4 text-xs text-gray-500 flex-wrap">
                <span class="flex items-center gap-1">
                  <User class="w-3 h-3 text-yellow-500/70" />
                  {topic.author_name}
                </span>
                <span class="flex items-center gap-1">
                  <MessageSquare class="w-3 h-3 text-yellow-500/70" />
                  {topic.comments_count || 0}
                </span>
                <span class="flex items-center gap-1">
                  <Eye class="w-3 h-3 text-yellow-500/70" />
                  {topic.views_count || 0}
                </span>
                <span class="flex items-center gap-1">
                  <Calendar class="w-3 h-3 text-yellow-500/70" />
                  {new Date(topic.created_at).toLocaleDateString('es-ES')}
                </span>
              </div>
            </div>
          </a>
        ))}
      </div>
    )}

    <!-- Pagination -->
    <Pagination
      currentPage={pagination.page}
      totalPages={pagination.totalPages}
      baseUrl={`/forum/category/${id}`}
    />
  </section>
</Layout>

<script>
  import { t, getStoredLanguage } from '../../../i18n/translations';

  function applyTranslations() {
    const lang = getStoredLanguage();

    // Breadcrumb
    document.querySelectorAll('.forum-breadcrumb-home').forEach(el => {
      el.textContent = t('pages.forum.home', lang);
    });
    document.querySelectorAll('.forum-breadcrumb-forum').forEach(el => {
      el.textContent = t('pages.forum.title', lang);
    });

    // New topic button
    document.querySelectorAll('.forum-new-topic-btn span').forEach(el => {
      el.textContent = t('pages.forum.newTopic', lang);
    });

    // No topics text
    document.querySelectorAll('.forum-no-topics-text').forEach(el => {
      el.textContent = t('pages.forum.noTopicsInCategory', lang);
    });

    // Create first topic button
    document.querySelectorAll('.forum-create-first-btn span').forEach(el => {
      el.textContent = t('pages.forum.createFirstTopic', lang);
    });

    // Votes label
    document.querySelectorAll('.forum-votes-label').forEach(el => {
      el.textContent = t('pages.forum.votes', lang);
    });

    // Pinned label
    document.querySelectorAll('.forum-pinned-label span').forEach(el => {
      el.textContent = t('pages.forum.pinned', lang);
    });

    // Locked label
    document.querySelectorAll('.forum-locked-label span').forEach(el => {
      el.textContent = t('pages.forum.locked', lang);
    });
  }

  applyTranslations();
  document.addEventListener('astro:page-load', applyTranslations);
</script>
