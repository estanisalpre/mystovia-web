---
export const prerender = false;

import Layout from '../../../layouts/Layout.astro';
import VoteButtons from '../../../components/VoteButtons.astro';
import { hasPermission } from '../../../utils/permissions';

const { id } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';

// Get user
const accessToken = Astro.cookies.get('accessToken')?.value;
let user = null;

if (accessToken) {
  try {
    const verifyResponse = await fetch(`${API_URL}/api/auth/verify`, {
      headers: { Cookie: `accessToken=${accessToken}` }
    });
    if (verifyResponse.ok) {
      const data = await verifyResponse.json();
      user = data.user;
    }
  } catch (error) {
    console.error('Error verifying user:', error);
  }
}

const canWriteForum = hasPermission(user?.groupId, 'write_forum');
const canManageForum = hasPermission(user?.groupId, 'manage_forum');

// Fetch topic
let topicData;

try {
  const response = await fetch(`${API_URL}/api/forum/topics/${id}`);
  topicData = await response.json();

  if (!topicData.success) {
    return Astro.redirect('/forum');
  }
} catch (error) {
  console.error('Error fetching topic:', error);
  return Astro.redirect('/forum');
}

const { topic, comments } = topicData;
---

<Layout title={topic.title}>
  <div class="container mx-auto px-4 py-8 max-w-5xl">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-4">
      <ul>
        <li><a href="/">Inicio</a></li>
        <li><a href="/forum">Foro</a></li>
        <li><a href={`/forum/category/${topic.category_id}`}>Categor√≠a</a></li>
        <li>{topic.title}</li>
      </ul>
    </div>

    <!-- Topic Header -->
    <div class="card bg-base-100 shadow-xl mb-6">
      <div class="card-body">
        <div class="flex gap-4">
          <VoteButtons
            topicId={topic.id}
            totalVotes={topic.total_votes}
            userVote={topic.userVote}
            isAuthenticated={!!user}
          />

          <div class="flex-1">
            <div class="flex items-start gap-2 mb-3">
              {topic.is_pinned && <span class="badge badge-warning">üìå Fijado</span>}
              {topic.is_locked && <span class="badge badge-error">üîí Cerrado</span>}
            </div>

            <h1 class="text-3xl font-bold mb-4">{topic.title}</h1>

            <div class="flex items-center gap-4 text-sm text-base-content/60 mb-4">
              <span class="flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                {topic.author_name}
              </span>
              <span>{new Date(topic.created_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
              <span>üëÅÔ∏è {topic.views_count} vistas</span>
            </div>

            <div class="prose max-w-none" set:html={topic.content}></div>

            {canManageForum && (
              <div class="flex gap-2 mt-4 pt-4 border-t border-base-300">
                <button
                  onclick={`togglePin(${topic.id}, ${topic.is_pinned})`}
                  class="btn btn-sm btn-outline"
                >
                  {topic.is_pinned ? 'Desfijar' : 'Fijar'}
                </button>
                <button
                  onclick={`toggleLock(${topic.id}, ${topic.is_locked})`}
                  class="btn btn-sm btn-outline"
                >
                  {topic.is_locked ? 'Desbloquear' : 'Bloquear'}
                </button>
                <button
                  onclick={`deleteTopic(${topic.id})`}
                  class="btn btn-sm btn-error btn-outline"
                >
                  Eliminar
                </button>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>

    <!-- Comments -->
    <div class="mb-6">
      <h2 class="text-2xl font-bold mb-4">
        üí¨ Respuestas ({comments.length})
      </h2>

      <div class="space-y-4">
        {comments.map((comment: any) => (
          <div class="card bg-base-100 shadow">
            <div class="card-body p-4">
              <div class="flex items-start gap-3">
                <div class="avatar placeholder">
                  <div class="bg-neutral text-neutral-content rounded-full w-10">
                    <span class="text-xs">{comment.author_name[0].toUpperCase()}</span>
                  </div>
                </div>

                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="font-semibold">{comment.author_name}</span>
                    <span class="text-xs text-base-content/60">
                      {new Date(comment.created_at).toLocaleDateString('es-ES')}
                    </span>
                  </div>

                  <div class="prose prose-sm max-w-none">{comment.content}</div>

                  {canManageForum && (
                    <button
                      onclick={`deleteComment(${comment.id})`}
                      class="btn btn-xs btn-error btn-outline mt-2"
                    >
                      Eliminar
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>

    <!-- Comment Form -->
    {canWriteForum && !topic.is_locked ? (
      <div class="card bg-base-100 shadow-xl" x-data="commentForm()">
        <div class="card-body">
          <h3 class="card-title">Agregar Respuesta</h3>

          <form @submit.prevent="submitComment">
            <textarea
              x-model="content"
              class="textarea textarea-bordered w-full h-32"
              placeholder="Escribe tu respuesta..."
              required
            ></textarea>

            <div class="flex gap-2 mt-4">
              <button
                type="submit"
                class="btn btn-primary"
                :disabled="loading"
              >
                <span x-show="!loading">Publicar Respuesta</span>
                <span x-show="loading" class="loading loading-spinner"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    ) : !canWriteForum ? (
      <div class="alert alert-info">
        <span><a href="/login" class="link">Inicia sesi√≥n</a> para responder</span>
      </div>
    ) : (
      <div class="alert alert-warning">
        <span>üîí Este tema est√° cerrado y no acepta nuevas respuestas</span>
      </div>
    )}
  </div>
</Layout>

<script>
  function commentForm() {
    return {
      content: '',
      loading: false,
      async submitComment() {
        this.loading = true;
        try {
          const response = await fetch(`/api/forum/topics/${(window as any).topicId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ content: this.content })
          });

          const data = await response.json();

          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Error al publicar respuesta');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al publicar respuesta');
        } finally {
          this.loading = false;
        }
      }
    };
  }

  (window as any).topicId = topic.id;

  async function togglePin(topicId: number, isPinned: boolean) {
    if (!confirm(`¬ø${isPinned ? 'Desfijar' : 'Fijar'} este tema?`)) return;

    try {
      const response = await fetch(`/api/forum/topics/${topicId}/pin`, {
        method: 'PATCH',
        credentials: 'include'
      });

      if (response.ok) {
        window.location.reload();
      } else {
        alert('Error al cambiar el estado');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al cambiar el estado');
    }
  }

  async function toggleLock(topicId: number, isLocked: boolean) {
    if (!confirm(`¬ø${isLocked ? 'Desbloquear' : 'Bloquear'} este tema?`)) return;

    try {
      const response = await fetch(`/api/forum/topics/${topicId}/lock`, {
        method: 'PATCH',
        credentials: 'include'
      });

      if (response.ok) {
        window.location.reload();
      } else {
        alert('Error al cambiar el estado');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al cambiar el estado');
    }
  }

  async function deleteTopic(topicId: number) {
    if (!confirm('¬øEst√°s seguro de eliminar este tema? Esta acci√≥n no se puede deshacer.')) return;

    try {
      const response = await fetch(`/api/forum/topics/${topicId}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (response.ok) {
        window.location.href = '/forum';
      } else {
        alert('Error al eliminar el tema');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al eliminar el tema');
    }
  }

  async function deleteComment(commentId: number) {
    if (!confirm('¬øEliminar este comentario?')) return;

    try {
      const response = await fetch(`/api/forum/comments/${commentId}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (response.ok) {
        window.location.reload();
      } else {
        alert('Error al eliminar el comentario');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al eliminar el comentario');
    }
  }
</script>

<style>
  .prose {
    color: inherit;
  }
</style>
