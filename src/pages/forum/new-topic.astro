---
import Layout from '../../layouts/Layout.astro';
import { PenLine, ChevronRight, Home, FolderOpen, Type, FileText, User, AlertTriangle, Info } from '@lucide/astro';
import DiamondPattern from "../../components/ui/DiamondPattern.astro";
import GoldenLine from "../../components/ui/GoldenLine.astro";
import CornerOrnaments from "../../components/ui/CornerOrnaments.astro";

// For internal SSR calls, use localhost with the same port (same Express server)
const INTERNAL_API_URL = `http://localhost:${process.env.PORT || 3301}`;

// Get user from cookies
const userId = Astro.cookies.get('userId')?.value;
let user = null;
let userCharacters: any[] = [];

if (userId) {
  try {
    // Verify user
    const verifyResponse = await fetch(`${INTERNAL_API_URL}/api/auth/verify`, {
      headers: { Cookie: `userId=${userId}` }
    });
    if (verifyResponse.ok) {
      const data = await verifyResponse.json();
      user = data.user;
    }

    // Get user characters
    const charactersResponse = await fetch(`${INTERNAL_API_URL}/api/characters`, {
      headers: { Cookie: `userId=${userId}` }
    });
    if (charactersResponse.ok) {
      const data = await charactersResponse.json();
      userCharacters = data.characters || [];
    }
  } catch (error) {
    console.error('Error fetching user data:', error);
  }
}

// Redirect if not logged in
if (!user) {
  return Astro.redirect('/login?redirect=/forum/new-topic');
}

// Fetch categories
let categoriesData;

try {
  const response = await fetch(`${INTERNAL_API_URL}/api/forum/categories`);
  categoriesData = await response.json();
} catch (error) {
  console.error('Error fetching categories:', error);
  categoriesData = { categories: [] };
}

const { categories } = categoriesData;
const selectedCategory = Astro.url.searchParams.get('category');
---

<Layout title="Crear Nuevo Tema | Mystovia">
  <section class="page-container max-w-3xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-xs sm:text-sm text-gray-400 mb-4 sm:mb-6">
      <a href="/" class="hover:text-yellow-500 transition-colors flex items-center gap-1">
        <Home class="w-3 h-3" />
        Inicio
      </a>
      <ChevronRight class="w-3 h-3 text-gray-600" />
      <a href="/forum" class="hover:text-yellow-500 transition-colors">Foro</a>
      <ChevronRight class="w-3 h-3 text-gray-600" />
      <span class="text-yellow-500">Nuevo Tema</span>
    </nav>

    <!-- Main Card -->
    <div class="relative overflow-hidden rounded-xl">
      <!-- Medieval container background -->
      <div class="absolute inset-0 bg-gradient-to-b from-gray-900/95 via-gray-900/98 to-black/95 border border-yellow-600/20 rounded-xl"></div>

      <GoldenLine position="top" />
      <DiamondPattern opacity={0.03} class="rounded-xl" />
      <CornerOrnaments variant="curve" size="md" opacity={0.2} />

      <!-- Form content -->
      <form id="topicForm" class="relative z-10 p-6 sm:p-8 space-y-6">
        <!-- Title with decorative elements -->
        <div class="text-center mb-6">
          <div class="flex items-center justify-center gap-3 mb-3">
            <div class="h-px w-8 sm:w-12 bg-gradient-to-r from-transparent to-yellow-500/50"></div>
            <PenLine class="w-5 h-5 sm:w-6 sm:h-6 text-yellow-500/70" />
            <div class="h-px w-8 sm:w-12 bg-gradient-to-l from-transparent to-yellow-500/50"></div>
          </div>
          <h1 class="text-2xl sm:text-3xl font-bold text-white medieval-font">Crear Nuevo Tema</h1>
          <p class="text-sm text-gray-400 mt-2">Comparte tus ideas con la comunidad</p>
        </div>

        <!-- Character Select -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm font-semibold text-gray-300">
            <User class="w-4 h-4 text-yellow-500/70" />
            Publicar como
          </label>
          <div class="relative">
            <select
              id="characterId"
              class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700/50 rounded-lg text-white focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/30 transition-all appearance-none cursor-pointer"
              required
            >
              {userCharacters.length === 0 ? (
                <option value="">No tienes personajes</option>
              ) : (
                <>
                  <option value="">Selecciona un personaje</option>
                  {userCharacters.map((char: any) => (
                    <option value={char.id}>
                      {char.name} - Nivel {char.level} {char.vocation}
                    </option>
                  ))}
                </>
              )}
            </select>
            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
              <ChevronRight class="w-4 h-4 text-gray-400 rotate-90" />
            </div>
          </div>
          {userCharacters.length === 0 && (
            <p class="text-xs text-yellow-500/70 flex items-center gap-1">
              <AlertTriangle class="w-3 h-3" fill="currentColor" />
              Necesitas crear un personaje para publicar en el foro
            </p>
          )}
        </div>

        <!-- Category Select -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm font-semibold text-gray-300">
            <FolderOpen class="w-4 h-4 text-yellow-500/70" />
            Categoría
          </label>
          <div class="relative">
            <select
              id="categoryId"
              class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700/50 rounded-lg text-white focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/30 transition-all appearance-none cursor-pointer"
              required
            >
              <option value="">Selecciona una categoría</option>
              {categories.map((cat: any) => (
                <option
                  value={cat.id}
                  selected={selectedCategory === cat.id.toString()}
                >
                  {cat.name}
                </option>
              ))}
            </select>
            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
              <ChevronRight class="w-4 h-4 text-gray-400 rotate-90" />
            </div>
          </div>
        </div>

        <!-- Title Input -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm font-semibold text-gray-300">
            <Type class="w-4 h-4 text-yellow-500/70" />
            Título
          </label>
          <input
            type="text"
            id="title"
            class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700/50 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/30 transition-all"
            placeholder="Escribe un título descriptivo..."
            maxlength="255"
            required
          />
        </div>

        <!-- Content Textarea -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm font-semibold text-gray-300">
            <FileText class="w-4 h-4 text-yellow-500/70" />
            Contenido
          </label>
          <textarea
            id="content"
            class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700/50 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/30 transition-all resize-y"
            style="min-height: 500px;"
            placeholder="Escribe el contenido de tu tema..."
            required
          ></textarea>
          <p class="text-xs text-gray-500 flex items-center gap-1">
            <Info class="w-3 h-3" fill="currentColor" />
            Puedes usar Markdown para dar formato a tu texto
          </p>
        </div>

        <!-- Decorative divider -->
        <div class="flex items-center gap-3 py-2">
          <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent"></div>
        </div>

        <!-- Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
          <button
            type="submit"
            id="submitBtn"
            class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-b from-yellow-600 to-yellow-700 hover:from-yellow-500 hover:to-yellow-600 text-white font-semibold rounded-lg transition-all duration-300 border border-yellow-500/30 shadow-[0_0_15px_rgba(202,138,4,0.2)] hover:shadow-[0_0_20px_rgba(202,138,4,0.4)]"
          >
            <PenLine class="w-4 h-4" />
            <span>Crear Tema</span>
          </button>
          <a
            href="/forum"
            class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-b from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-white font-semibold rounded-lg transition-all duration-300 border border-gray-600/30"
          >
            Cancelar
          </a>
        </div>
      </form>
    </div>
  </section>
</Layout>

<script>
  const form = document.getElementById('topicForm') as HTMLFormElement;
  const characterSelect = document.getElementById('characterId') as HTMLSelectElement;
  const categorySelect = document.getElementById('categoryId') as HTMLSelectElement;
  const titleInput = document.getElementById('title') as HTMLInputElement;
  const contentTextarea = document.getElementById('content') as HTMLTextAreaElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const characterId = characterSelect.value;
    const categoryId = categorySelect.value;
    const title = titleInput.value;
    const content = contentTextarea.value;

    if (!characterId || !categoryId || !title || !content) {
      alert('Por favor completa todos los campos');
      return;
    }

    // Disable button and show loading
    submitBtn.disabled = true;
    const originalContent = submitBtn.innerHTML;
    submitBtn.innerHTML = `
      <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>Creando...</span>
    `;

    try {
      // Use relative URL for same-origin requests (avoids cross-domain cookie issues)
      const response = await fetch('/api/forum/topics', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          categoryId: parseInt(categoryId),
          characterId: parseInt(characterId),
          title,
          content
        })
      });

      const data = await response.json();

      if (data.success) {
        window.location.href = `/forum/topic/${data.topicId}`;
      } else {
        alert(data.error || 'Error al crear el tema');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalContent;
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al crear el tema');
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalContent;
    }
  });
</script>
