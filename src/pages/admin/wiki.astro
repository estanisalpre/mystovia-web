---
import Layout from '../../layouts/Layout.astro';
import { hasPermission } from '../../utils/permissions';

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';

const accessToken = Astro.cookies.get('accessToken')?.value;
let user = null;

if (accessToken) {
  try {
    const verifyResponse = await fetch(`${API_URL}/api/auth/verify`, {
      headers: { Cookie: `accessToken=${accessToken}` }
    });
    if (verifyResponse.ok) {
      const data = await verifyResponse.json();
      user = data.user;
    }
  } catch (error) {
    console.error('Error verifying user:', error);
  }
}

if (!hasPermission(user?.groupId, 'manage_wiki')) {
  return Astro.redirect('/');
}

let articlesData;
let categoriesData;

try {
  const [articlesResponse, categoriesResponse] = await Promise.all([
    fetch(`${API_URL}/api/wiki/admin/all`, {
      headers: { Cookie: `accessToken=${accessToken}` }
    }),
    fetch(`${API_URL}/api/wiki/categories`)
  ]);

  articlesData = await articlesResponse.json();
  categoriesData = await categoriesResponse.json();
} catch (error) {
  console.error('Error fetching data:', error);
  articlesData = { articles: [] };
  categoriesData = { categories: [] };
}

const { articles } = articlesData;
const { categories } = categoriesData;
---

<Layout title="Admin - Wiki">
  <section class="page-container">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">üìö Gesti√≥n de Wiki</h1>
      <div class="flex gap-2">
        <button @click="showCreateModal = true" class="btn btn-primary">+ Nuevo Art√≠culo</button>
        <a href="/admin" class="btn btn-ghost">‚Üê Volver</a>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>ID</th>
            <th>T√≠tulo</th>
            <th>Categor√≠a</th>
            <th>Slug</th>
            <th>Estado</th>
            <th>Vistas</th>
            <th>√öltima Act.</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {articles.map((article: any) => (
            <tr x-data={`articleRow(${article.id})`}>
              <td>{article.id}</td>
              <td class="max-w-xs truncate">{article.title}</td>
              <td><span class="badge badge-primary badge-sm">{article.category_name || 'Sin categor√≠a'}</span></td>
              <td class="text-xs text-base-content/60">{article.slug}</td>
              <td>
                <span class={`badge ${article.is_published ? 'badge-success' : 'badge-warning'}`}>
                  {article.is_published ? 'Publicado' : 'Borrador'}
                </span>
              </td>
              <td>{article.views_count}</td>
              <td>{new Date(article.updated_at).toLocaleDateString('es-ES')}</td>
              <td>
                <div class="flex gap-2">
                  <a href={`/wiki/${article.slug}`} class="btn btn-xs btn-info" target="_blank">Ver</a>
                  <button @click="deleteArticle()" class="btn btn-xs btn-error">Eliminar</button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- Modal Create -->
    <div x-data="wikiModal()" x-show="showCreateModal" class="modal modal-open" x-cloak>
      <div class="modal-box max-w-4xl">
        <h3 class="font-bold text-lg mb-4">Nuevo Art√≠culo</h3>

        <form @submit.prevent="saveArticle()">
          <div class="form-control mb-4">
            <label class="label"><span class="label-text">Categor√≠a</span></label>
            <select x-model="formData.categoryId" class="select select-bordered">
              <option value="">Sin categor√≠a</option>
              {categories.map((cat: any) => (
                <option value={cat.id}>{cat.name}</option>
              ))}
            </select>
          </div>

          <div class="form-control mb-4">
            <label class="label"><span class="label-text">T√≠tulo</span></label>
            <input type="text" x-model="formData.title" class="input input-bordered" required />
          </div>

          <div class="form-control mb-4">
            <label class="label"><span class="label-text">Slug (URL amigable)</span></label>
            <input type="text" x-model="formData.slug" class="input input-bordered" required
              @input="formData.slug = $event.target.value.toLowerCase().replace(/[^a-z0-9-]/g, '-')" />
            <label class="label"><span class="label-text-alt">Ejemplo: como-empezar</span></label>
          </div>

          <div class="form-control mb-4">
            <label class="label"><span class="label-text">Contenido</span></label>
            <textarea x-model="formData.content" class="textarea textarea-bordered h-64" required></textarea>
          </div>

          <div class="form-control mb-6">
            <label class="label cursor-pointer justify-start gap-3">
              <input type="checkbox" x-model="formData.isPublished" class="checkbox" />
              <span class="label-text">Publicar inmediatamente</span>
            </label>
          </div>

          <div class="modal-action">
            <button type="submit" class="btn btn-primary" :disabled="loading">
              <span x-show="!loading">Guardar</span>
              <span x-show="loading" class="loading loading-spinner"></span>
            </button>
            <button type="button" @click="showCreateModal = false" class="btn">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </section>
</Layout>

<script>
  let showCreateModal = false;

  function articleRow(articleId: number) {
    return {
      async deleteArticle() {
        if (!confirm('¬øEliminar este art√≠culo?')) return;

        try {
          const response = await fetch(`/api/wiki/admin/${articleId}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Error al eliminar');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al eliminar');
        }
      }
    };
  }

  function wikiModal() {
    return {
      showCreateModal: false,
      loading: false,
      formData: {
        categoryId: '',
        title: '',
        slug: '',
        content: '',
        isPublished: false
      },

      async saveArticle() {
        this.loading = true;

        try {
          const response = await fetch('/api/wiki/admin/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(this.formData)
          });

          if (response.ok) {
            window.location.reload();
          } else {
            const data = await response.json();
            alert(data.error || 'Error al guardar');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al guardar');
        } finally {
          this.loading = false;
        }
      }
    };
  }
</script>

<style>
  [x-cloak] { display: none !important; }
</style>
