---
import Layout from '../../layouts/Layout.astro';
import { hasPermission } from '../../utils/permissions';

// Use internal URL for SSR to avoid timeout on Render
const INTERNAL_API_URL = `http://localhost:${process.env.PORT || 3000}`;

const accessToken = Astro.cookies.get('accessToken')?.value;
let user = null;

if (accessToken) {
  try {
    const verifyResponse = await fetch(`${INTERNAL_API_URL}/api/auth/verify`, {
      headers: { Cookie: `accessToken=${accessToken}` }
    });
    if (verifyResponse.ok) {
      const data = await verifyResponse.json();
      user = data.user;
    }
  } catch (error) {
    console.error('Error verifying user:', error);
  }
}

if (!hasPermission(user?.groupId, 'manage_news')) {
  return Astro.redirect('/');
}

const page = parseInt(Astro.url.searchParams.get('page') || '1');

let newsData;
let categoriesData;

try {
  const [newsResponse, categoriesResponse] = await Promise.all([
    fetch(`${INTERNAL_API_URL}/api/news/admin/all?page=${page}&limit=20`, {
      headers: { Cookie: `accessToken=${accessToken}` }
    }),
    fetch(`${INTERNAL_API_URL}/api/news/categories`)
  ]);

  newsData = await newsResponse.json();
  categoriesData = await categoriesResponse.json();
} catch (error) {
  console.error('Error fetching data:', error);
  newsData = { news: [], pagination: { page: 1, totalPages: 1 } };
  categoriesData = { categories: [] };
}

const { news, pagination } = newsData;
const { categories } = categoriesData;
---

<Layout title="Admin - Noticias">
  <section class="page-container">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">üì∞ Gesti√≥n de Noticias</h1>
      <div class="flex gap-2">
        <button @click="showCreateModal = true" class="btn btn-primary">+ Nueva Noticia</button>
        <a href="/admin" class="btn btn-ghost">‚Üê Volver</a>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>ID</th>
            <th>T√≠tulo</th>
            <th>Categor√≠a</th>
            <th>Autor</th>
            <th>Estado</th>
            <th>Vistas</th>
            <th>Likes</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {news.map((item: any) => (
            <tr>
              <td>{item.id}</td>
              <td class="max-w-xs truncate">{item.title}</td>
              <td><span class="badge badge-primary badge-sm">{item.category_name || 'Sin categor√≠a'}</span></td>
              <td>{item.author_name}</td>
              <td>
                <span class={`badge ${item.is_published ? 'badge-success' : 'badge-warning'}`}>
                  {item.is_published ? 'Publicada' : 'Borrador'}
                </span>
              </td>
              <td>{item.views_count}</td>
              <td>{item.likes_count}</td>
              <td>{new Date(item.created_at).toLocaleDateString('es-ES')}</td>
              <td>
                <div class="flex gap-2">
                  <a href={`/news/${item.id}`} class="btn btn-xs btn-info" target="_blank">Ver</a>
                  <button onclick={`editNewsItem(${item.id}, ${JSON.stringify(JSON.stringify(item))})`} class="btn btn-xs btn-warning">Editar</button>
                  <button onclick={`deleteNewsItem(${item.id})`} class="btn btn-xs btn-error">Eliminar</button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    {pagination.totalPages > 1 && (
      <div class="flex justify-center gap-2 mt-6">
        {page > 1 && (
          <a href={`/admin/news?page=${page - 1}`} class="btn btn-outline">Anterior</a>
        )}
        <span class="btn btn-ghost">P√°gina {page} de {pagination.totalPages}</span>
        {page < pagination.totalPages && (
          <a href={`/admin/news?page=${page + 1}`} class="btn btn-outline">Siguiente</a>
        )}
      </div>
    )}

    <!-- Modal Create/Edit -->
    <div x-data="newsModal()" x-show="showCreateModal || editingNews" class="modal modal-open" x-cloak>
      <div class="modal-box max-w-4xl">
        <h3 class="font-bold text-lg mb-4" x-text="editingNews ? 'Editar Noticia' : 'Nueva Noticia'"></h3>

        <form @submit.prevent="saveNews()">
          <div class="form-control mb-4">
            <label class="label"><span class="label-text">Categor√≠a</span></label>
            <select x-model="formData.categoryId" class="select select-bordered">
              <option value="">Sin categor√≠a</option>
              {categories.map((cat: any) => (
                <option value={cat.id}>{cat.name}</option>
              ))}
            </select>
          </div>

          <div class="form-control mb-4">
            <label class="label"><span class="label-text">T√≠tulo</span></label>
            <input type="text" x-model="formData.title" class="input input-bordered" required />
          </div>

          <div class="form-control mb-4">
            <label class="label"><span class="label-text">URL de Imagen</span></label>
            <input type="url" x-model="formData.imageUrl" class="input input-bordered" />
          </div>

          <div class="form-control mb-4">
            <label class="label"><span class="label-text">Contenido</span></label>
            <textarea x-model="formData.content" class="textarea textarea-bordered h-64" required></textarea>
          </div>

          <div class="form-control mb-6">
            <label class="label cursor-pointer justify-start gap-3">
              <input type="checkbox" x-model="formData.isPublished" class="checkbox" />
              <span class="label-text">Publicar inmediatamente</span>
            </label>
          </div>

          <div class="modal-action">
            <button type="submit" class="btn btn-primary" :disabled="loading">
              <span x-show="!loading">Guardar</span>
              <span x-show="loading" class="loading loading-spinner"></span>
            </button>
            <button type="button" @click="closeModal()" class="btn">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</Layout>

<script>
  async function deleteNewsItem(newsId: number) {
    if (!confirm('¬øEliminar esta noticia?')) return;

    try {
      const response = await fetch(`/api/news/admin/${newsId}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (response.ok) {
        window.location.reload();
      } else {
        alert('Error al eliminar');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al eliminar');
    }
  }

  function editNewsItem(newsId: number, newsJson: string) {
    const news = JSON.parse(newsJson);
    // Disparar evento personalizado para Alpine.js
    window.dispatchEvent(new CustomEvent('edit-news', { detail: news }));
  }

  function newsModal() {
    return {
      showCreateModal: false,
      editingNews: null as any,
      loading: false,
      formData: {
        categoryId: '',
        title: '',
        imageUrl: '',
        content: '',
        isPublished: false
      },

      init() {
        // Escuchar evento de edici√≥n
        window.addEventListener('edit-news', ((event: CustomEvent) => {
          const news = event.detail;
          this.editingNews = news;
          this.formData = {
            categoryId: news.category_id || '',
            title: news.title,
            imageUrl: news.image_url || '',
            content: news.content,
            isPublished: news.is_published === 1
          };
        }) as EventListener);
      },

      closeModal() {
        this.showCreateModal = false;
        this.editingNews = null;
        this.formData = {
          categoryId: '',
          title: '',
          imageUrl: '',
          content: '',
          isPublished: false
        };
      },

      async saveNews() {
        this.loading = true;

        try {
          const url = this.editingNews
            ? `/api/news/admin/${(this.editingNews as any).id}`
            : '/api/news/admin/create';

          const method = this.editingNews ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(this.formData)
          });

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Error al guardar');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al guardar');
        } finally {
          this.loading = false;
        }
      }
    };
  }
</script>

<style>
  [x-cloak] { display: none !important; }
</style>
