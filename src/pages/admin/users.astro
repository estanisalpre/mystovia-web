---
import Layout from '../../layouts/Layout.astro';
import { hasPermission } from '../../utils/permissions';

// Use internal URL for SSR to avoid timeout on Render
const INTERNAL_API_URL = `http://localhost:${process.env.PORT || 3000}`;

const accessToken = Astro.cookies.get('accessToken')?.value;
let user = null;

if (accessToken) {
  try {
    const verifyResponse = await fetch(`${INTERNAL_API_URL}/api/auth/verify`, {
      headers: { Cookie: `accessToken=${accessToken}` }
    });
    if (verifyResponse.ok) {
      const data = await verifyResponse.json();
      user = data.user;
    }
  } catch (error) {
    console.error('Error verifying user:', error);
  }
}

if (!hasPermission(user?.groupId, 'manage_users')) {
  return Astro.redirect('/');
}

const page = parseInt(Astro.url.searchParams.get('page') || '1');
const search = Astro.url.searchParams.get('search') || '';

let usersData;
let rolesData;

try {
  const [usersResponse, rolesResponse] = await Promise.all([
    fetch(`${INTERNAL_API_URL}/api/admin/users/users?page=${page}&search=${search}`, {
      headers: { Cookie: `accessToken=${accessToken}` }
    }),
    fetch(`${INTERNAL_API_URL}/api/admin/users/roles`, {
      headers: { Cookie: `accessToken=${accessToken}` }
    })
  ]);

  usersData = await usersResponse.json();
  rolesData = await rolesResponse.json();
} catch (error) {
  console.error('Error fetching data:', error);
  usersData = { users: [], pagination: { page: 1, totalPages: 1 } };
  rolesData = { roles: [] };
}

const users = usersData?.users || [];
const pagination = usersData?.pagination || { page: 1, totalPages: 1 };
const roles = rolesData?.roles || [];
---

<Layout title="Gesti√≥n de Usuarios">
  <section class="page-container">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">üë• Gesti√≥n de Usuarios</h1>
      <a href="/admin" class="btn btn-ghost">‚Üê Volver al Panel</a>
    </div>

    <div class="mb-6">
      <form method="get" class="flex gap-2">
        <input
          type="text"
          name="search"
          value={search}
          placeholder="Buscar por nombre o email..."
          class="input input-bordered flex-1"
        />
        <button type="submit" class="btn btn-primary">Buscar</button>
      </form>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Premium</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {users.map((u: any) => (
            <tr data-user-id={u.id} data-group-id={u.group_id} data-blocked={u.blocked} x-data="userRow()">
              <td>{u.id}</td>
              <td>{u.name}</td>
              <td>{u.email}</td>
              <td>
                <select
                  @change="changeRole($event.target.value)"
                  class="select select-sm select-bordered"
                >
                  {roles.map((role: any) => (
                    <option value={role.groupId} selected={role.groupId === u.group_id}>
                      {role.name}
                    </option>
                  ))}
                </select>
              </td>
              <td>{u.premdays} d√≠as</td>
              <td>
                <span :class="`badge ${blocked ? 'badge-error' : 'badge-success'}`" x-text="blocked ? 'Bloqueado' : 'Activo'"></span>
              </td>
              <td>
                <div class="flex gap-2">
                  <button @click="toggleBlock()" class="btn btn-sm btn-warning" x-text="blocked ? 'Desbloquear' : 'Bloquear'"></button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    {pagination.totalPages > 1 && (
      <div class="flex justify-center gap-2 mt-6">
        {page > 1 && (
          <a href={`/admin/users?page=${page - 1}&search=${search}`} class="btn btn-outline">Anterior</a>
        )}
        <span class="btn btn-ghost">P√°gina {page} de {pagination.totalPages}</span>
        {page < pagination.totalPages && (
          <a href={`/admin/users?page=${page + 1}&search=${search}`} class="btn btn-outline">Siguiente</a>
        )}
      </div>
    )}
  </div>
</Layout>

<script>
  function userRow() {
    return {
      userId: null as number | null,
      blocked: false,
      $el: undefined as any,

      init() {
        const tr = this.$el.closest('tr');
        this.userId = parseInt(tr.dataset.userId || '0');
        this.blocked = tr.dataset.blocked === '1';
      },

      async changeRole(newGroupId: string) {
        if (!confirm('¬øCambiar el rol de este usuario?')) {
          window.location.reload();
          return;
        }

        try {
          const response = await fetch(`/api/admin/users/users/${this.userId}/role`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ groupId: parseInt(newGroupId) })
          });

          if (!response.ok) {
            alert('Error al cambiar rol');
            window.location.reload();
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al cambiar rol');
        }
      },

      async toggleBlock() {
        try {
          const response = await fetch(`/api/admin/users/users/${this.userId}/block`, {
            method: 'PATCH',
            credentials: 'include'
          });

          if (response.ok) {
            this.blocked = !this.blocked;
          } else {
            alert('Error al cambiar estado');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al cambiar estado');
        }
      }
    };
  }
</script>
