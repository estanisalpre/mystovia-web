---
import Layout from '../../layouts/Layout.astro';
import { hasPermission } from '../../utils/permissions';

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';

const accessToken = Astro.cookies.get('accessToken')?.value;
let user = null;

if (accessToken) {
  try {
    const verifyResponse = await fetch(`${API_URL}/api/auth/verify`, {
      headers: { Cookie: `accessToken=${accessToken}` }
    });
    if (verifyResponse.ok) {
      const data = await verifyResponse.json();
      user = data.user;
    }
  } catch (error) {
    console.error('Error verifying user:', error);
  }
}

if (!hasPermission(user?.groupId, 'manage_support')) {
  return Astro.redirect('/');
}

const status = Astro.url.searchParams.get('status') || '';
const priority = Astro.url.searchParams.get('priority') || '';

let ticketsData;

try {
  const params = new URLSearchParams();
  if (status) params.append('status', status);
  if (priority) params.append('priority', priority);

  const response = await fetch(`${API_URL}/api/support/admin/tickets?${params.toString()}`, {
    headers: { Cookie: `accessToken=${accessToken}` }
  });

  ticketsData = await response.json();
} catch (error) {
  console.error('Error fetching tickets:', error);
  ticketsData = { tickets: [] };
}

const { tickets } = ticketsData;

const getStatusColor = (status: string) => {
  switch (status) {
    case 'open': return 'badge-warning';
    case 'in_progress': return 'badge-info';
    case 'resolved': return 'badge-success';
    case 'closed': return 'badge-error';
    default: return 'badge-ghost';
  }
};

const getPriorityColor = (priority: string) => {
  switch (priority) {
    case 'high': return 'badge-error';
    case 'medium': return 'badge-warning';
    case 'low': return 'badge-info';
    default: return 'badge-ghost';
  }
};
---

<Layout title="Admin - Soporte">
  <section class="page-container">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">üí¨ Gesti√≥n de Tickets</h1>
      <a href="/admin" class="btn btn-ghost">‚Üê Volver</a>
    </div>

    <!-- Filters -->
    <div class="flex gap-4 mb-6">
      <div class="form-control">
        <label class="label"><span class="label-text">Estado</span></label>
        <select
          class="select select-bordered"
          onchange={`window.location.href = '/admin/support?status=' + this.value + '${priority ? '&priority=' + priority : ''}'`}
        >
          <option value="" selected={!status}>Todos</option>
          <option value="open" selected={status === 'open'}>Abiertos</option>
          <option value="in_progress" selected={status === 'in_progress'}>En Progreso</option>
          <option value="resolved" selected={status === 'resolved'}>Resueltos</option>
          <option value="closed" selected={status === 'closed'}>Cerrados</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text">Prioridad</span></label>
        <select
          class="select select-bordered"
          onchange={`window.location.href = '/admin/support?priority=' + this.value + '${status ? '&status=' + status : ''}'`}
        >
          <option value="" selected={!priority}>Todas</option>
          <option value="high" selected={priority === 'high'}>Alta</option>
          <option value="medium" selected={priority === 'medium'}>Media</option>
          <option value="low" selected={priority === 'low'}>Baja</option>
        </select>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>ID</th>
            <th>Asunto</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Estado</th>
            <th>Prioridad</th>
            <th>Respuestas</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {tickets.map((ticket: any) => (
            <tr x-data={`ticketRow(${ticket.id}, '${ticket.status}', '${ticket.priority}')`}>
              <td>{ticket.id}</td>
              <td class="max-w-xs truncate">{ticket.subject}</td>
              <td>{ticket.name}</td>
              <td class="text-xs">{ticket.email}</td>
              <td><span class={`badge ${getStatusColor(ticket.status)}`}>{ticket.status}</span></td>
              <td><span class={`badge ${getPriorityColor(ticket.priority)}`}>{ticket.priority}</span></td>
              <td>{ticket.responses_count}</td>
              <td>{new Date(ticket.created_at).toLocaleDateString('es-ES')}</td>
              <td>
                <div class="dropdown dropdown-end">
                  <label tabindex="0" class="btn btn-xs btn-ghost">‚öôÔ∏è</label>
                  <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-200 rounded-box w-52 z-10">
                    <li><button @click="changeStatus('in_progress')">En Progreso</button></li>
                    <li><button @click="changeStatus('resolved')">Resolver</button></li>
                    <li><button @click="changeStatus('closed')">Cerrar</button></li>
                    <li class="menu-title"><span>Prioridad</span></li>
                    <li><button @click="changePriority('high')">Alta</button></li>
                    <li><button @click="changePriority('medium')">Media</button></li>
                    <li><button @click="changePriority('low')">Baja</button></li>
                    <li class="border-t mt-2"><button @click="deleteTicket()" class="text-error">Eliminar</button></li>
                  </ul>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    {tickets.length === 0 && (
      <div class="text-center py-12">
        <p class="text-lg text-base-content/70">No hay tickets con los filtros seleccionados.</p>
      </div>
    )}
  </section>
</Layout>

<script>
  function ticketRow(ticketId: number, initialStatus: string, initialPriority: string) {
    return {
      async changeStatus(newStatus: string) {
        try {
          const response = await fetch(`/api/support/admin/tickets/${ticketId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status: newStatus })
          });

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Error al actualizar');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al actualizar');
        }
      },

      async changePriority(newPriority: string) {
        try {
          const response = await fetch(`/api/support/admin/tickets/${ticketId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ priority: newPriority })
          });

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Error al actualizar');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al actualizar');
        }
      },

      async deleteTicket() {
        if (!confirm('¬øEliminar este ticket?')) return;

        try {
          const response = await fetch(`/api/support/admin/tickets/${ticketId}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Error al eliminar');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al eliminar');
        }
      }
    };
  }
</script>
