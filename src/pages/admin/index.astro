---
import Layout from "@layouts/Layout.astro";
import { hasPermission } from "@utils/permissions";
import {
  BrickWallShield,
  Users,
  Store,
  Megaphone,
  Rss,
} from "@lucide/astro";
import StatsCard from "@c/admin/StatsCard.astro";
import ModalButton from "@c/admin/ModalButton.astro";
import HeaderComponent from "@components/shared/HeaderComponent.astro";

// Use internal URL for SSR to avoid timeout on Render
const INTERNAL_API_URL = `http://localhost:${process.env.PORT || 3301}`;

/* ⏸️ JWT DESACTIVADO TEMPORALMENTE
const accessToken = Astro.cookies.get("accessToken")?.value;
*/

const userId = Astro.cookies.get("userId")?.value;
const userEmail = Astro.cookies.get("userEmail")?.value;
let user = null;

if (userId && userEmail) {
  try {
    const verifyResponse = await fetch(`${INTERNAL_API_URL}/api/auth/verify`, {
      headers: { Cookie: `userId=${userId}; userEmail=${userEmail}` },
    });
    if (verifyResponse.ok) {
      const data = await verifyResponse.json();
      user = data.user;
    }
  } catch (error) {
    console.error("Error verifying user:", error);
  }
}

if (!hasPermission(user?.groupId, "view_admin_panel")) {
  return Astro.redirect("/");
}

let stats = null;
try {
  const response = await fetch(`${INTERNAL_API_URL}/api/admin/users/stats`, {
    headers: { Cookie: `userId=${userId}; userEmail=${userEmail}` },
  });
  const data = await response.json();
  stats = data.stats;
} catch (error) {
  console.error("Error fetching stats:", error);
}
---

<Layout title="Panel de Administración">
  <section class="page-container">
    <HeaderComponent
      title="Panel de Administración"
      description="Gestiona y supervisa todos los aspectos de la plataforma desde aquí."
      icon={BrickWallShield}
    />

    {
      stats && (
        <header class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          <StatsCard
            statsTitle="Total Usuarios"
            statsValue={stats.totalUsers}
          />
          <StatsCard
            statsTitle="Usuarios Activos"
            statsValue={stats.activeUsers}
          />
          <StatsCard
            statsTitle="Premium"
            statsValue={stats.premiumUsers}
          />
          <StatsCard
            statsTitle="Bloqueados"
            statsValue={stats.blockedUsers}
          />
        </header>
      )
    }

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <ModalButton
        user={user}
        permission="manage_users"
        btnName="Usuarios"
        btnDescription="Gestionar usuarios y roles"
        url="/admin/users"
        icon={Users}
      />

      <ModalButton
        user={user}
        permission="manage_marketplace"
        btnName="Tienda"
        btnDescription="Administrar tienda y productos"
        url="/admin/marketplace"
        icon={Store}
      />

      <ModalButton
        user={user}
        permission="manage_forum"
        btnName="Foro"
        btnDescription="Moderar foro, temas y comentarios"
        url="/admin/forum"
        icon={Megaphone}
      />

      <ModalButton
        user={user}
        permission="manage_news"
        btnName="Noticias"
        btnDescription="Crear y gestionar noticias"
        url="/admin/news"
        icon={Rss}
      />
    </section>
  </section>
</Layout>
