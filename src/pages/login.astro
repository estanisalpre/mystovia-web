---
import Layout from "../layouts/Layout.astro";
import Input from "@ui/Input.astro";
import ErrorMessage from "@ui/ErrorMessage.astro";
import SubmitBtn from "@ui/SubmitBtn.astro";
import { Star, HelpCircle } from '@lucide/astro';
import DiamondPattern from "../components/ui/DiamondPattern.astro";
import GoldenLine from "../components/ui/GoldenLine.astro";
import CornerOrnaments from "../components/ui/CornerOrnaments.astro";

let error = "";
---

<Layout
  title="Iniciar Sesión"
  description="Inicia sesión en tu cuenta de Mystovia para acceder a tus personajes, el marketplace y todas las funciones del servidor."
  keywords="login mystovia, iniciar sesion tibia, acceder cuenta, entrar mystovia"
>
  <section class="grow z-100 flex items-center justify-center min-h-screen py-12 px-4">
    <div class="relative max-w-md w-full overflow-hidden">
      <!-- Medieval container background -->
      <div class="absolute inset-0 rounded-xl bg-gradient-to-b from-gray-900/95 via-gray-900/98 to-black/95 border border-yellow-600/20"></div>

      <!-- Top golden line -->
      <GoldenLine position="top" />

      <!-- Diamond pattern overlay -->
      <DiamondPattern opacity={0.03} class="rounded-xl" />

      <!-- Corner ornaments -->
      <CornerOrnaments variant="curve" size="lg" opacity={0.2} />

      <!-- Form content -->
      <form
        id="loginForm"
        class="relative z-10 p-8 space-y-6"
      >
        <!-- Title with decorative elements -->
        <header class="text-center mb-8">
          <figure class="flex items-center justify-center gap-3 mb-2" aria-hidden="true">
            <span class="h-px w-12 bg-gradient-to-r from-transparent to-yellow-500/50"></span>
            <Star class="w-5 h-5 text-yellow-500/60" fill="currentColor" />
            <span class="h-px w-12 bg-gradient-to-l from-transparent to-yellow-500/50"></span>
          </figure>
          <h2 id="loginTitle" class="text-3xl font-bold text-white medieval-font">Iniciar sesión</h2>
        </header>

        <Input
          id="email"
          label="Email o Account number"
          type="text"
          placeholder="you@email.com o account number"
          required
        />
        <Input
          id="password"
          label="Password"
          type="password"
          placeholder="••••••••"
          required
        />

        <div class="text-right -mt-4">
          <a
            href="/forgot-password"
            id="forgotPasswordLink"
            class="text-sm text-yellow-500 hover:text-yellow-400 transition-colors"
          >
            ¿Olvidaste tu contraseña?
          </a>
        </div>

        <ErrorMessage
          message={error}
          visible={!!error}
        />

        <SubmitBtn label="INICIAR SESIÓN" id="loginBtn" />

        <p id="noAccountText" class="text-center text-sm text-gray-400">
          ¿No tenes cuenta aún? <a
            href="/register"
            id="registerLink"
            class="text-yellow-500 hover:text-yellow-400 font-medium"
            >Registrate</a
          >
        </p>

        <!-- Decorative divider -->
        <div class="flex items-center gap-3 pt-2">
          <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent"></div>
        </div>

        <!-- Lost Account Link -->
        <nav class="pt-2">
          <a
            href="/lost-account"
            id="lostAccountLink"
            class="flex items-center justify-center gap-2 text-sm text-gray-400 hover:text-yellow-500 transition-colors"
          >
            <HelpCircle class="w-4 h-4" />
            <span>Lost Account?</span>
          </a>
        </nav>
      </form>
    </div>
  </section>

  <script>
    import { useAuth } from "@hooks/useAuth";
    import { t, getStoredLanguage } from "../i18n/translations";

    function applyTranslations() {
      const lang = getStoredLanguage();

      const loginTitle = document.getElementById("loginTitle");
      if (loginTitle) loginTitle.textContent = t("auth.login", lang);

      const loginBtn = document.getElementById("loginBtn");
      if (loginBtn) loginBtn.textContent = t("auth.loginButton", lang);

      const noAccountText = document.getElementById("noAccountText");
      const registerLink = document.getElementById("registerLink");
      if (noAccountText && registerLink) {
        noAccountText.childNodes[0].textContent = t("auth.noAccount", lang) + " ";
        registerLink.textContent = t("auth.register", lang);
      }

      const forgotPasswordLink = document.getElementById("forgotPasswordLink");
      if (forgotPasswordLink) forgotPasswordLink.textContent = t("auth.forgotPasswordLink", lang);

      const lostAccountLink = document.getElementById("lostAccountLink");
      if (lostAccountLink) {
        const span = lostAccountLink.querySelector("span");
        if (span) span.textContent = t("auth.lostAccount", lang);
      }
    }

    function setupForm() {
      const form = document.getElementById("loginForm") as HTMLFormElement & {
        email: HTMLInputElement;
        password: HTMLInputElement;
      };

      form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = form.email.value;
        const password = form.password.value;

        const res = await useAuth("login", { email, password });
        if (res.success) window.location.href = "/create-character";
        else alert(res.error);
      });
    }

    applyTranslations();
    setupForm();
    document.addEventListener('astro:page-load', () => {
      applyTranslations();
      setupForm();
    });
  </script>
</Layout>
