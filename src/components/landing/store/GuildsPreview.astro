---
import { Shield, Users, Crown, ChevronRight } from '@lucide/astro';

// For internal SSR calls, use localhost (same Express server)
const INTERNAL_API_URL = `http://localhost:${process.env.PORT || 3301}`;

interface Guild {
  id: number;
  name: string;
  owner_name: string;
  owner_level: number;
  member_count: number;
  has_logo: boolean;
}

let guilds: Guild[] = [];

try {
  const response = await fetch(`${INTERNAL_API_URL}/api/guilds/top?limit=5`);
  if (response.ok) {
    const data = await response.json();
    guilds = data.guilds || [];
  }
} catch (error) {
  console.error('Error fetching guilds:', error);
}
---

<div class="relative rounded-xl overflow-hidden"
     style="background: linear-gradient(to bottom, rgb(31 41 55 / 0.6), rgb(17 24 39 / 0.8)); border: 1px solid rgb(234 179 8 / 0.15);">
  <!-- Top golden line -->
  <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-yellow-500/30 to-transparent"></div>

  <!-- Diamond pattern overlay -->
  <div class="absolute inset-0 opacity-[0.02] pointer-events-none"
       style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M30 0L60 30L30 60L0 30z\' fill=\'%23d4af37\' fill-opacity=\'0.4\'/%3E%3C/svg%3E'); background-size: 30px 30px;"></div>

  <!-- Header -->
  <div class="flex items-center justify-between px-4 py-3 border-b border-yellow-600/20 bg-black/20">
    <h3 class="flex items-center gap-2 text-yellow-500 font-bold medieval-font">
      <Shield class="w-5 h-5" />
      Top Guilds
    </h3>
    <a href="/guilds" class="flex items-center gap-1 text-xs text-yellow-500/70 hover:text-yellow-500 transition-colors">
      Ver todas
      <ChevronRight class="w-3 h-3" />
    </a>
  </div>

  <!-- Content -->
  <div class="relative z-10">
    {guilds.length === 0 ? (
      <div class="py-8 text-center">
        <Shield class="w-10 h-10 mx-auto text-yellow-500/30 mb-3" />
        <p class="text-gray-500 text-sm">No hay guilds creadas aÃºn</p>
        <a href="/guilds/create" class="inline-block mt-2 text-yellow-500 hover:text-yellow-400 text-sm transition-colors">
          SÃ© el primero
        </a>
      </div>
    ) : (
      <div class="divide-y divide-yellow-600/10">
        {guilds.map((guild, index) => {
          let rankDisplay = (index + 1).toString();
          if (index === 0) rankDisplay = 'ðŸ¥‡';
          else if (index === 1) rankDisplay = 'ðŸ¥ˆ';
          else if (index === 2) rankDisplay = 'ðŸ¥‰';

          const isTop3 = index < 3;
          const bgStyle = isTop3
            ? `background: linear-gradient(to right, rgb(234 179 8 / ${0.08 - index * 0.02}), transparent);`
            : '';

          return (
            <a href={`/guilds/${guild.id}`}
               class="flex items-center gap-3 px-4 py-3 hover:bg-yellow-500/5 transition-all group"
               style={bgStyle}>
              <!-- Rank -->
              <span class={`w-6 text-center ${isTop3 ? 'text-base' : 'text-gray-500 text-sm'}`}>{rankDisplay}</span>

              <!-- Guild Emblem -->
              <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-yellow-600/30 to-yellow-800/30 border border-yellow-500/20 flex items-center justify-center flex-shrink-0 overflow-hidden">
                {guild.has_logo ? (
                  <img src={`${INTERNAL_API_URL}/api/guilds/${guild.id}/logo`} alt={guild.name} class="w-full h-full object-cover" />
                ) : (
                  <span class="text-sm font-bold text-yellow-500">{guild.name[0].toUpperCase()}</span>
                )}
              </div>

              <!-- Guild Info -->
              <div class="flex-1 min-w-0">
                <div class="text-white font-semibold text-sm group-hover:text-yellow-500 transition-colors truncate">
                  {guild.name}
                </div>
                <div class="text-gray-500 text-xs flex items-center gap-2">
                  <span class="flex items-center gap-1">
                    <Crown class="w-3 h-3 text-yellow-500/50" />
                    {guild.owner_name || 'Desconocido'}
                  </span>
                </div>
              </div>

              <!-- Member Count -->
              <div class="flex items-center gap-1 text-gray-400 text-sm">
                <Users class="w-4 h-4 text-yellow-500/50" />
                <span>{guild.member_count}</span>
              </div>
            </a>
          );
        })}
      </div>
    )}
  </div>
</div>
