---
import { Users, ChevronRight } from '@lucide/astro';

// For internal SSR calls, use localhost (same Express server)
const INTERNAL_API_URL = `http://localhost:${process.env.PORT || 3301}`;

interface Player {
  id: number;
  name: string;
  level: number;
  vocation: string;
}

let players: Player[] = [];
let total = 0;

try {
  const response = await fetch(`${INTERNAL_API_URL}/api/server/online?limit=5`);
  if (response.ok) {
    const data = await response.json();
    players = data.players || [];
    total = data.total || 0;
  }
} catch (error) {
  console.error('Error fetching online players:', error);
}
---

<div class="relative rounded-xl overflow-hidden"
     style="background: linear-gradient(to bottom, rgb(31 41 55 / 0.6), rgb(17 24 39 / 0.8)); border: 1px solid rgb(234 179 8 / 0.15);">
  <!-- Top golden line -->
  <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-yellow-500/30 to-transparent"></div>

  <!-- Diamond pattern overlay -->
  <div class="absolute inset-0 opacity-[0.02] pointer-events-none"
       style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M30 0L60 30L30 60L0 30z\' fill=\'%23d4af37\' fill-opacity=\'0.4\'/%3E%3C/svg%3E'); background-size: 30px 30px;"></div>

  <!-- Header -->
  <div class="flex items-center justify-between px-4 py-3 border-b border-yellow-600/20 bg-black/20">
    <h3 id="onlineTitle" class="flex items-center gap-2 text-yellow-500 font-bold medieval-font">
      <Users class="w-5 h-5" />
      Players Online
      <span class="text-xs font-normal text-gray-400">({total})</span>
    </h3>
    <a href="/online" class="flex items-center gap-1 text-xs text-yellow-500/70 hover:text-yellow-500 transition-colors">
      <span id="viewAllOnlineBtn">Ver todos</span>
      <ChevronRight class="w-3 h-3" />
    </a>
  </div>

  <!-- Content -->
  <div class="relative z-10">
    {players.length === 0 ? (
      <div class="py-8 text-center">
        <Users class="w-10 h-10 mx-auto text-yellow-500/30 mb-3" />
        <p id="noPlayersText" class="text-gray-500 text-sm">No hay jugadores online</p>
      </div>
    ) : (
      <div class="divide-y divide-yellow-600/10">
        {players.map((player) => (
          <a href={`/character-information?name=${encodeURIComponent(player.name)}`}
             class="flex items-center gap-3 px-4 py-3 hover:bg-yellow-500/5 transition-all group">
            <!-- Online indicator -->
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse flex-shrink-0"></div>

            <!-- Player Info -->
            <div class="flex-1 min-w-0">
              <div class="text-white font-semibold text-sm group-hover:text-yellow-500 transition-colors truncate">
                {player.name}
              </div>
              <div class="text-gray-500 text-xs">
                {player.vocation}
              </div>
            </div>

            <!-- Level -->
            <div class="text-yellow-500 font-bold text-sm medieval-font">
              {player.level}
            </div>
          </a>
        ))}
      </div>
    )}
  </div>
</div>

<script>
  import { t, getStoredLanguage } from '../../../i18n/translations';

  function applyTranslations() {
    const lang = getStoredLanguage();

    const onlineTitle = document.getElementById('onlineTitle');
    if (onlineTitle) {
      const icon = onlineTitle.querySelector('svg');
      const countSpan = onlineTitle.querySelector('span');
      if (icon && countSpan) {
        const count = countSpan.textContent;
        onlineTitle.innerHTML = '';
        onlineTitle.appendChild(icon);
        onlineTitle.appendChild(document.createTextNode(' ' + t('landing.playersOnline', lang) + ' '));
        const newCountSpan = document.createElement('span');
        newCountSpan.className = 'text-xs font-normal text-gray-400';
        newCountSpan.textContent = count || '';
        onlineTitle.appendChild(newCountSpan);
      }
    }

    const viewAllOnlineBtn = document.getElementById('viewAllOnlineBtn');
    if (viewAllOnlineBtn) viewAllOnlineBtn.textContent = t('landing.viewAll', lang);

    const noPlayersText = document.getElementById('noPlayersText');
    if (noPlayersText) noPlayersText.textContent = t('landing.noPlayersOnline', lang);
  }

  applyTranslations();
  document.addEventListener('astro:page-load', applyTranslations);
</script>
