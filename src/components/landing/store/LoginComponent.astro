---
import Input from "@ui/Input.astro";
import ErrorMessage from "@ui/ErrorMessage.astro";
import SubmitBtn from "@lib/components/ui/SubmitBtn.astro";
import DiamondPattern from "../../ui/DiamondPattern.astro";
import GoldenLine from "../../ui/GoldenLine.astro";
import CornerOrnaments from "../../ui/CornerOrnaments.astro";
import { Diamond } from '@lucide/astro';

let error = "";
---

<form
  id="loginForm"
  class="relative w-full h-full rounded-xl overflow-hidden"
  style="background: linear-gradient(to bottom, rgb(17 24 39 / 0.98), rgb(17 24 39), rgb(0 0 0 / 0.98));"
>
  <!-- Diamond pattern overlay -->
  <DiamondPattern opacity={0.03} class="rounded-xl" />

  <!-- Top golden line -->
  <GoldenLine position="top" />

  <!-- Border -->
  <span class="absolute inset-0 rounded-xl border border-yellow-600/20 pointer-events-none" aria-hidden="true"></span>

  <!-- Corner ornaments -->
  <CornerOrnaments variant="curve" size="md" opacity={0.2} offset={2} />

  <!-- Content -->
  <div class="relative z-10 p-5 pt-12">
    <!-- Header badge -->
    <div class="absolute -top-0.5 left-1/2 -translate-x-1/2">
      <div class="relative px-6 py-2 rounded-b-lg" style="background: linear-gradient(to bottom, rgb(234 179 8 / 0.9), rgb(202 138 4 / 0.9));">
        <div class="absolute inset-0 rounded-b-lg border border-yellow-400/30 pointer-events-none"></div>
        <h2 id="loginTitle" class="text-sm font-bold text-black text-center medieval-font relative z-10">Ingresar</h2>
      </div>
    </div>

    <Input
      id="email"
      label="Correo electrónico"
      type="email"
      placeholder="tu@correo.com"
      required
    />
    <Input
      id="password"
      label="Contraseña"
      type="password"
      placeholder="••••••••"
      required
    />

    <ErrorMessage
      message={error}
      visible={!!error}
    />

    <SubmitBtn label="INGRESAR" id="loginSubmitBtn" />

    <!-- Decorative divider -->
    <div class="flex items-center gap-2 my-3">
      <div class="flex-1 h-px bg-gradient-to-r from-transparent via-yellow-500/20 to-transparent"></div>
      <Diamond class="w-3 h-3 text-yellow-500/40" fill="currentColor" />
      <div class="flex-1 h-px bg-gradient-to-r from-transparent via-yellow-500/20 to-transparent"></div>
    </div>

    <p id="noAccountText" class="text-center text-sm text-gray-400">
      ¿No tenes una cuenta? <a
        id="registerLink"
        href="/register"
        class="text-yellow-500 hover:text-yellow-400 font-medium transition-colors"
        >Registrate</a
      >
    </p>
  </div>
</form>

<script>
  import { useAuth } from "@hooks/useAuth";
  import { t, getStoredLanguage } from '../../../i18n/translations';

  function applyTranslations() {
    const lang = getStoredLanguage();

    const loginTitle = document.getElementById('loginTitle');
    if (loginTitle) loginTitle.textContent = t('landing.login', lang);

    const loginSubmitBtn = document.getElementById('loginSubmitBtn');
    if (loginSubmitBtn) loginSubmitBtn.textContent = t('auth.loginButton', lang);

    const noAccountText = document.getElementById('noAccountText');
    const registerLink = document.getElementById('registerLink');
    if (noAccountText && registerLink) {
      noAccountText.childNodes[0].textContent = t('landing.noAccount', lang) + ' ';
      registerLink.textContent = t('landing.registerNow', lang);
    }

    // Update input labels
    const emailInput = document.getElementById('email') as HTMLInputElement;
    if (emailInput) {
      const label = emailInput.parentElement?.querySelector('label');
      if (label) label.textContent = t('auth.email', lang);
      emailInput.placeholder = t('auth.emailPlaceholder', lang);
    }

    const passwordInput = document.getElementById('password') as HTMLInputElement;
    if (passwordInput) {
      const label = passwordInput.parentElement?.querySelector('label');
      if (label) label.textContent = t('auth.password', lang);
    }
  }

  applyTranslations();
  document.addEventListener('astro:page-load', applyTranslations);

  const form = document.getElementById("loginForm") as HTMLFormElement & {
    email: HTMLInputElement;
    password: HTMLInputElement;
  };

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = form.email.value;
    const password = form.password.value;

    const res = await useAuth("login", { email, password });
    if (res.success) window.location.href = "/create-character";
    else alert(res.error);
  });
</script>
